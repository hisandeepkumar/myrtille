<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Myrtille Industries - Professional Invoice Generator</title>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100vh;
      color: #f0f0f0;
      background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('https://4kwallpapers.com/images/wallpapers/macos-big-sur-apple-layers-fluidic-colorful-wwdc-stock--1455.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      padding: 20px;
    }

    .main-container {
      max-width: 800px;
      margin: 0 auto;
    }

    /* Form Container */
    .form-container {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(16px);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2), 0 4px 16px rgba(255, 255, 255, 0.1), inset 0 1px 2px rgba(255, 255, 255, 0.3);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 30px;
    }

    .header {
      padding-bottom: 24px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      margin-bottom: 24px;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 600;
      color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .header h1 i {
      color: #5b86e5;
      font-size: 28px;
    }

    .header p {
      color: rgba(255, 255, 255, 0.8);
      margin-top: 8px;
      font-size: 16px;
    }

    /* Toggle Switch Container */
    .toggle-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin: 24px 0;
    }

    @media (max-width: 768px) {
      .toggle-container {
        grid-template-columns: 1fr;
      }
    }

    .toggle-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      text-align: left;
    }

    .toggle-btn.active {
      background: rgba(91, 134, 229, 0.3);
      border-color: #5b86e5;
      box-shadow: 0 0 15px rgba(91, 134, 229, 0.4);
    }

    .toggle-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.15);
    }

    .toggle-btn .toggle-label {
      font-weight: 600;
      font-size: 14px;
      color: #5b86e5;
    }

    .toggle-btn .toggle-description {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 4px;
    }

    .toggle-switch-small {
      width: 40px;
      height: 20px;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      position: relative;
      transition: background 0.3s ease, border-color 0.3s ease;
    }

    .toggle-switch-small::before {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      background: #f0f0f0;
      border-radius: 50%;
      top: 1.5px;
      left: 1.5px;
      transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55), background 0.3s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .toggle-btn.active .toggle-switch-small {
      background: #34c759;
      border-color: #34c759;
    }

    .toggle-btn.active .toggle-switch-small::before {
      transform: translateX(20px);
      background: #ffffff;
    }

    /* Form Styles */
    .form-section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #5b86e5;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      font-size: 18px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .form-group {
      margin-bottom: 18px;
    }

    .form-group label {
      display: block;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
    }

    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 14px 16px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      font-size: 15px;
      transition: all 0.3s ease;
    }

    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: #5b86e5;
      box-shadow: 0 0 0 2px rgba(91, 134, 229, 0.3);
      background: rgba(255, 255, 255, 0.2);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Items Table */
    .items-table-container {
      overflow-x: auto;
      margin-bottom: 20px;
    }

    .items-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
    }

    .items-table th {
      background: rgba(91, 134, 229, 0.3);
      color: #fff;
      font-weight: 600;
      padding: 14px 12px;
      text-align: left;
      font-size: 14px;
    }

    .items-table td {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .items-table input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
    }

    .items-table input:focus {
      outline: none;
      border-color: #5b86e5;
    }

    .item-actions {
      display: flex;
      gap: 8px;
    }

    /* Buttons */
    .btn {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(12px);
      color: #f0f0f0;
      border: 1px solid rgba(255, 255, 255, 0.4);
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 8px 24px rgba(91, 134, 229, 0.4), 0 4px 12px rgba(0, 0, 0, 0.2), inset 0 2px 4px rgba(255, 255, 255, 0.3);
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(91, 134, 229, 0.5), 0 6px 16px rgba(0, 0, 0, 0.3), inset 0 2px 4px rgba(255, 255, 255, 0.4);
    }

    .btn-primary {
      background: rgba(91, 134, 229, 0.7);
      border-color: #5b86e5;
    }

    .btn-primary:hover {
      background: rgba(91, 134, 229, 0.9);
    }

    .btn-secondary {
      background: rgba(52, 199, 89, 0.3);
      border-color: #34c759;
    }

    .btn-secondary:hover {
      background: rgba(52, 199, 89, 0.5);
    }

    .btn-danger {
      background: rgba(255, 59, 48, 0.3);
      border-color: #ff3b30;
    }

    .btn-danger:hover {
      background: rgba(255, 59, 48, 0.5);
    }

    .btn-small {
      padding: 8px 12px;
      font-size: 13px;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    /* Status Area */
    .status-area {
      display: none;
      margin-top: 24px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .status-area.active {
      display: block;
    }

    .status-header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }

    .status-header i {
      margin-right: 12px;
      color: #5b86e5;
      font-size: 20px;
    }

    .status-header h3 {
      font-size: 18px;
      font-weight: 500;
      color: #f0f0f0;
    }

    .progress-container {
      background: rgba(255, 255, 255, 0.1);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #5b86e5, #36d1dc);
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    .status-message {
      margin-top: 12px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
    }

    .success-message, .error-message {
      display: none;
      padding: 16px;
      border-radius: 12px;
      font-size: 14px;
      text-align: center;
      margin-top: 24px;
    }

    .success-message {
      background: rgba(52, 199, 89, 0.2);
      color: #34c759;
      border: 1px solid rgba(52, 199, 89, 0.3);
    }

    .error-message {
      background: rgba(255, 59, 48, 0.2);
      color: #ff3b30;
      border: 1px solid rgba(255, 59, 48, 0.3);
    }

    .success-message i, .error-message i {
      margin-right: 8px;
    }

    /* Back Button */
    .back-button {
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 2147483647;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.55), rgba(255, 255, 255, 0.15));
      backdrop-filter: blur(14px) saturate(160%);
      -webkit-backdrop-filter: blur(14px) saturate(160%);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18), inset 0 1px 1px rgba(255, 255, 255, 0.7);
      transition: transform .35s cubic-bezier(.2, .8, .2, 1), box-shadow .35s cubic-bezier(.2, .8, .2, 1);
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    .back-button:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 18px 45px rgba(0, 0, 0, .28), inset 0 1px 1px rgba(255, 255, 255, .85);
    }

    .back-button:hover svg {
      transform: rotate(360deg);
    }

    .back-button svg {
      position: relative;
      z-index: 2;
      transition: transform .35s ease;
    }

    .back-button span {
      position: absolute;
      inset: -6px;
      border-radius: 50%;
      background: conic-gradient(from 0deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, .6), rgba(255, 255, 255, 0));
      filter: blur(8px);
      opacity: .6;
      animation: spin 6s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Watermark Toggle */
    .watermark-toggle {
      margin: 20px 0;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .watermark-toggle label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    .watermark-toggle input[type="checkbox"] {
      display: none;
    }

    .watermark-toggle .slider {
      width: 50px;
      height: 24px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      position: relative;
      transition: all 0.3s ease;
    }

    .watermark-toggle .slider::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: #f0f0f0;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .watermark-toggle input:checked + .slider {
      background: #34c759;
    }

    .watermark-toggle input:checked + .slider::before {
      transform: translateX(26px);
      background: #ffffff;
    }

    /* Invoice Template Selector */
    .template-selector {
      margin: 20px 0;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .template-selector h4 {
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 12px;
      font-size: 14px;
      font-weight: 600;
    }

    .template-options {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .template-option {
      flex: 1;
      min-width: 100px;
      padding: 10px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .template-option:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .template-option.active {
      background: rgba(91, 134, 229, 0.3);
      border-color: #5b86e5;
      box-shadow: 0 0 10px rgba(91, 134, 229, 0.3);
    }

    .template-option i {
      font-size: 20px;
      margin-bottom: 5px;
      display: block;
    }

    .template-option span {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.9);
    }
  </style>
</head>
<body>
  <!-- Back Button -->
  <button class="back-button" onclick="history.back()">
    <span></span>
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M15 18l-6-6 6-6" stroke="rgba(20,20,20,.9)" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <div class="main-container">
    <!-- Form Container -->
    <div class="form-container">
      <div class="header">
        <h1><i class="fas fa-file-invoice"></i> Myrtille Industries Invoice Generator</h1>
        <p>Professional invoice generator with modern templates</p>
      </div>

      <!-- Toggle Buttons -->
      <div class="toggle-container">
        <div class="toggle-btn" id="logoToggle">
          <div>
            <div class="toggle-label">Company Logo</div>
            <div class="toggle-description">Add Myrtille Industries logo</div>
          </div>
          <div class="toggle-switch-small"></div>
        </div>

        <div class="toggle-btn" id="watermarkToggle">
          <div>
            <div class="toggle-label">Watermark</div>
            <div class="toggle-description">Add "PAID" or "UNPAID" watermark</div>
          </div>
          <div class="toggle-switch-small"></div>
        </div>

        <div class="toggle-btn" id="qrCodeToggle">
          <div>
            <div class="toggle-label">QR Code</div>
            <div class="toggle-description">Add payment QR code</div>
          </div>
          <div class="toggle-switch-small"></div>
        </div>

        <div class="toggle-btn" id="colorSchemeToggle">
          <div>
            <div class="toggle-label">Color Scheme</div>
            <div class="toggle-description">Use blue color scheme</div>
          </div>
          <div class="toggle-switch-small"></div>
        </div>
      </div>

      <!-- Invoice Template Selector -->
      <div class="template-selector">
        <h4>Invoice Template</h4>
        <div class="template-options">
          <div class="template-option active" data-template="modern" onclick="selectTemplate('modern')">
            <i class="fas fa-palette"></i>
            <span>Modern</span>
          </div>
          <div class="template-option" data-template="classic" onclick="selectTemplate('classic')">
            <i class="fas fa-building"></i>
            <span>Classic</span>
          </div>
          <div class="template-option" data-template="minimal" onclick="selectTemplate('minimal')">
            <i class="fas fa-stream"></i>
            <span>Minimal</span>
          </div>
          <div class="template-option" data-template="professional" onclick="selectTemplate('professional')">
            <i class="fas fa-briefcase"></i>
            <span>Professional</span>
          </div>
        </div>
      </div>

      <!-- Watermark Status -->
      <div class="watermark-toggle">
        <label>
          <span>Invoice Status</span>
          <div>
            <input type="checkbox" id="paidStatus" checked>
            <div class="slider"></div>
          </div>
        </label>
        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7); margin-top: 8px;">
          Toggle for PAID (checked) or UNPAID (unchecked) watermark
        </div>
      </div>

      <form id="invoiceForm">
        <!-- Company Details -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-building"></i>
            <span>Company Details</span>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="invoiceNumber">Invoice Number</label>
              <input type="text" id="invoiceNumber" value="INV-2024-001" required>
            </div>
            
            <div class="form-group">
              <label for="invoiceDate">Invoice Date</label>
              <input type="date" id="invoiceDate" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="dueDate">Due Date</label>
              <input type="date" id="dueDate">
            </div>
            
            <div class="form-group">
              <label for="poNumber">PO Number (Optional)</label>
              <input type="text" id="poNumber">
            </div>
          </div>
        </div>

        <!-- Bill To Section -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-user-tie"></i>
            <span>Bill To</span>
          </div>
          
          <div class="form-group">
            <label for="customerName">Customer Name</label>
            <input type="text" id="customerName" value="SUPERINTENDENT CUM MEMBER SECRETARY RMRS" required>
          </div>
          
          <div class="form-group">
            <label for="customerAddress">Customer Address</label>
            <textarea id="customerAddress" required>SUPER SPECIALITY HOSPITAL, RNT MEDICAL COLLEGE, UDAIPUR</textarea>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="customerContact">Contact No.</label>
              <input type="text" id="customerContact" value="9829851042" required>
            </div>
            
            <div class="form-group">
              <label for="customerEmail">Email (Optional)</label>
              <input type="email" id="customerEmail">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="customerGST">Customer GSTIN (Optional)</label>
              <input type="text" id="customerGST">
            </div>
            
            <div class="form-group">
              <label for="customerState">State Code (Optional)</label>
              <input type="text" id="customerState" placeholder="e.g., 08">
            </div>
          </div>
        </div>

        <!-- Items Section -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-list"></i>
            <span>Invoice Items</span>
          </div>
          
          <div class="items-table-container">
            <table class="items-table" id="itemsTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Item Name</th>
                  <th>HSN/SAC</th>
                  <th>Qty</th>
                  <th>Price/Unit (Rs.)</th>
                  <th>GST %</th>
                  <th>Amount (Rs.)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="itemsTableBody">
                <!-- Items will be added here dynamically -->
              </tbody>
            </table>
          </div>
          
          <button type="button" class="btn btn-secondary" id="addItemBtn">
            <i class="fas fa-plus"></i> Add Item
          </button>
          
          <div class="form-row" style="margin-top: 20px;">
            <div class="form-group">
              <label for="discount">Discount (Rs.)</label>
              <input type="number" id="discount" value="0" min="0" step="0.01">
            </div>
            
            <div class="form-group">
              <label for="shipping">Shipping Charges (Rs.)</label>
              <input type="number" id="shipping" value="0" min="0" step="0.01">
            </div>
          </div>
        </div>

        <!-- Payment Details -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-rupee-sign"></i>
            <span>Payment Details</span>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="amountReceived">Amount Received (Rs.)</label>
              <input type="number" id="amountReceived" value="0" min="0" step="0.01">
            </div>
            
            <div class="form-group">
              <label for="paymentMode">Payment Mode</label>
              <select id="paymentMode">
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Cash">Cash</option>
                <option value="Cheque">Cheque</option>
                <option value="Online">Online</option>
                <option value="UPI">UPI</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label for="bankDetails">Bank Details (for transfer)</label>
            <textarea id="bankDetails">Account Name: Myrtille Industries
Account No.: 921020038756944
Bank: Axis Bank, Swej Farm, Jaipur
IFSC: UTIB0002582</textarea>
          </div>
          
          <div class="form-group">
            <label for="terms">Terms and Conditions</label>
            <textarea id="terms">1. Payment due within 30 days of invoice date.
2. Late payment interest @18% p.a.
3. Goods once sold will not be taken back.
4. All disputes subject to Jaipur jurisdiction.
5. Thank you for doing business with us.</textarea>
          </div>
          
          <div class="form-group">
            <label for="notes">Additional Notes (Optional)</label>
            <textarea id="notes" placeholder="Any additional information or notes..."></textarea>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="button-group">
          <button type="button" class="btn btn-primary" id="generateInvoiceBtn">
            <i class="fas fa-file-pdf"></i> Generate Invoice PDF
          </button>
          
          <button type="button" class="btn btn-danger" id="resetFormBtn">
            <i class="fas fa-redo"></i> Reset Form
          </button>
          
          <button type="button" class="btn" id="saveTemplateBtn">
            <i class="fas fa-save"></i> Save as Template
          </button>
        </div>
      </form>

      <!-- Status Area -->
      <div class="status-area" id="statusArea">
        <div class="status-header">
          <i class="fas fa-cog fa-spin"></i>
          <h3>Generating your invoice...</h3>
        </div>
        <div class="progress-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="status-message" id="statusMessage">Initializing PDF generation...</div>
      </div>

      <!-- Success/Error Messages -->
      <div class="success-message" id="successMessage">
        <i class="fas fa-check-circle"></i> Invoice generated successfully!
      </div>
      
      <div class="error-message" id="errorMessage">
        <i class="fas fa-exclamation-circle"></i> <span id="errorText">Error generating invoice</span>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize date fields
      const today = new Date();
      const dueDate = new Date();
      dueDate.setDate(today.getDate() + 30);
      
      document.getElementById('invoiceDate').value = today.toISOString().split('T')[0];
      document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
      
      // Add initial item row
      addItemRow();
      
      // Set up event listeners
      document.getElementById('addItemBtn').addEventListener('click', addItemRow);
      document.getElementById('generateInvoiceBtn').addEventListener('click', generateInvoicePDF);
      document.getElementById('resetFormBtn').addEventListener('click', resetForm);
      document.getElementById('saveTemplateBtn').addEventListener('click', saveTemplate);
      
      // Toggle button event listeners
      document.getElementById('logoToggle').addEventListener('click', function() {
        this.classList.toggle('active');
      });
      
      document.getElementById('watermarkToggle').addEventListener('click', function() {
        this.classList.toggle('active');
      });
      
      document.getElementById('qrCodeToggle').addEventListener('click', function() {
        this.classList.toggle('active');
      });
      
      document.getElementById('colorSchemeToggle').addEventListener('click', function() {
        this.classList.toggle('active');
      });
      
      // Add sample data for demo
      addSampleData();
    });
    
    // Template selection
    let selectedTemplate = 'modern';
    
    function selectTemplate(template) {
      selectedTemplate = template;
      document.querySelectorAll('.template-option').forEach(opt => {
        opt.classList.remove('active');
      });
      document.querySelector(`.template-option[data-template="${template}"]`).classList.add('active');
    }
    
    // Function to add a new item row
    function addItemRow(itemData = {}) {
      const tbody = document.getElementById('itemsTableBody');
      const rowCount = tbody.children.length + 1;
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${rowCount}</td>
        <td><input type="text" class="item-name" value="${itemData.name || ''}" placeholder="Item name"></td>
        <td><input type="text" class="item-hsn" value="${itemData.hsn || ''}" placeholder="HSN/SAC code"></td>
        <td><input type="number" class="item-quantity" value="${itemData.quantity || 1}" min="1" step="1"></td>
        <td><input type="number" class="item-price" value="${itemData.price || 0}" min="0" step="0.01"></td>
        <td>
          <select class="item-gst">
            <option value="0" ${itemData.gst === 0 ? 'selected' : ''}>0%</option>
            <option value="5" ${itemData.gst === 5 ? 'selected' : ''}>5%</option>
            <option value="12" ${itemData.gst === 12 ? 'selected' : ''}>12%</option>
            <option value="18" ${itemData.gst === 18 ? 'selected' : ''}>18%</option>
            <option value="28" ${itemData.gst === 28 ? 'selected' : ''}>28%</option>
          </select>
        </td>
        <td class="item-amount">Rs. 0.00</td>
        <td>
          <div class="item-actions">
            <button type="button" class="btn btn-small" onclick="calculateItemAmount(this)">
              <i class="fas fa-calculator"></i>
            </button>
            <button type="button" class="btn btn-small btn-danger" onclick="removeItemRow(this)">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      `;
      
      tbody.appendChild(row);
      
      // Add event listeners to inputs for auto-calculation
      const inputs = row.querySelectorAll('.item-quantity, .item-price, .item-gst');
      inputs.forEach(input => {
        input.addEventListener('input', () => calculateItemAmount(row));
      });
      
      // Calculate initial amount
      calculateItemAmount(row);
    }
    
    // Function to calculate item amount
    function calculateItemAmount(element) {
      const row = element.closest ? element.closest('tr') : element;
      const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
      const price = parseFloat(row.querySelector('.item-price').value) || 0;
      const gst = parseFloat(row.querySelector('.item-gst').value) || 0;
      
      const subtotal = quantity * price;
      const gstAmount = subtotal * (gst / 100);
      const total = subtotal + gstAmount;
      
      row.querySelector('.item-amount').textContent = `Rs. ${total.toFixed(2)}`;
      
      // Update the row number if needed
      updateRowNumbers();
    }
    
    // Function to remove an item row
    function removeItemRow(button) {
      const row = button.closest('tr');
      row.remove();
      updateRowNumbers();
    }
    
    // Function to update row numbers
    function updateRowNumbers() {
      const rows = document.querySelectorAll('#itemsTableBody tr');
      rows.forEach((row, index) => {
        row.querySelector('td:first-child').textContent = index + 1;
      });
    }
    
    // Function to calculate invoice totals
    function calculateInvoiceTotals() {
      const rows = document.querySelectorAll('#itemsTableBody tr');
      let subtotal = 0;
      let totalGST = 0;
      let totalAmount = 0;
      let cgst = 0;
      let sgst = 0;
      let igst = 0;
      
      // Check if customer is in same state (Rajasthan - 08)
      const customerState = document.getElementById('customerState').value;
      const isSameState = customerState === '08' || customerState === '' || !customerState;
      
      rows.forEach(row => {
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        const gst = parseFloat(row.querySelector('.item-gst').value) || 0;
        
        const itemSubtotal = quantity * price;
        const itemGST = itemSubtotal * (gst / 100);
        
        subtotal += itemSubtotal;
        totalGST += itemGST;
        
        if (isSameState) {
          // CGST and SGST split equally
          cgst += itemGST / 2;
          sgst += itemGST / 2;
        } else {
          // IGST
          igst += itemGST;
        }
      });
      
      totalAmount = subtotal + totalGST;
      
      // Apply discount and shipping
      const discount = parseFloat(document.getElementById('discount').value) || 0;
      const shipping = parseFloat(document.getElementById('shipping').value) || 0;
      
      totalAmount = totalAmount - discount + shipping;
      
      return {
        subtotal: subtotal.toFixed(2),
        totalGST: totalGST.toFixed(2),
        cgst: cgst.toFixed(2),
        sgst: sgst.toFixed(2),
        igst: igst.toFixed(2),
        discount: discount.toFixed(2),
        shipping: shipping.toFixed(2),
        totalAmount: totalAmount.toFixed(2),
        isSameState: isSameState
      };
    }
    
    // Function to convert number to words
    function numberToWords(num) {
      const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
      const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
      
      const number = parseFloat(num);
      const rupees = Math.floor(number);
      const paisa = Math.round((number - rupees) * 100);
      
      let rupeesWords = '';
      let paisaWords = '';
      
      if (rupees === 0) {
        rupeesWords = 'Zero';
      } else if (rupees < 20) {
        rupeesWords = a[rupees];
      } else if (rupees < 100) {
        rupeesWords = b[Math.floor(rupees / 10)] + (rupees % 10 !== 0 ? ' ' + a[rupees % 10] : '');
      } else if (rupees < 1000) {
        rupeesWords = a[Math.floor(rupees / 100)] + 'hundred ' + numberToWords(rupees % 100);
      } else if (rupees < 100000) {
        rupeesWords = numberToWords(Math.floor(rupees / 1000)) + 'thousand ' + numberToWords(rupees % 1000);
      } else if (rupees < 10000000) {
        rupeesWords = numberToWords(Math.floor(rupees / 100000)) + 'lakh ' + numberToWords(rupees % 100000);
      } else {
        rupeesWords = numberToWords(Math.floor(rupees / 10000000)) + 'crore ' + numberToWords(rupees % 10000000);
      }
      
      if (paisa > 0) {
        if (paisa < 20) {
          paisaWords = a[paisa];
        } else {
          paisaWords = b[Math.floor(paisa / 10)] + (paisa % 10 !== 0 ? ' ' + a[paisa % 10] : '');
        }
      }
      
      let result = rupeesWords.trim().charAt(0).toUpperCase() + rupeesWords.trim().slice(1) + ' Rupees';
      
      if (paisa > 0) {
        result += ' and ' + paisaWords.trim() + ' Paisa';
      }
      
      return result + ' only';
    }
    
    // Function to generate QR code image
    async function generateQRCode(pdfDoc, upiId = "myrtilleindia@axisbank", amount = "0") {
      try {
        // Create a simple QR code using text representation (in real app, use a QR code library)
        // For demo, we'll create a simple rectangle with text
        return null;
      } catch (error) {
        console.log('QR code generation skipped:', error);
        return null;
      }
    }
    
    // Function to generate invoice PDF
    async function generateInvoicePDF() {
      // Show status
      const statusArea = document.getElementById('statusArea');
      const progressBar = document.getElementById('progressBar');
      const statusMessage = document.getElementById('statusMessage');
      const successMessage = document.getElementById('successMessage');
      const errorMessage = document.getElementById('errorMessage');
      
      successMessage.style.display = 'none';
      errorMessage.style.display = 'none';
      statusArea.classList.add('active');
      statusMessage.textContent = "Starting PDF generation...";
      progressBar.style.width = "10%";
      
      try {
        // Create PDF document
        const pdfDoc = await PDFLib.PDFDocument.create();
        const page = pdfDoc.addPage([595.28, 841.89]); // A4 size
        
        // Load fonts
        const helveticaFont = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
        const helveticaBoldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
        const helveticaObliqueFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaOblique);
        
        // Get toggle states
        const addLogo = document.getElementById('logoToggle').classList.contains('active');
        const addWatermark = document.getElementById('watermarkToggle').classList.contains('active');
        const addQRCode = document.getElementById('qrCodeToggle').classList.contains('active');
        const useColorScheme = document.getElementById('colorSchemeToggle').classList.contains('active');
        const isPaid = document.getElementById('paidStatus').checked;
        
        // Define colors based on template and toggle
        let primaryColor, secondaryColor, accentColor;
        
        switch(selectedTemplate) {
          case 'modern':
            primaryColor = useColorScheme ? PDFLib.rgb(0.2, 0.4, 0.8) : PDFLib.rgb(0.1, 0.1, 0.1);
            secondaryColor = useColorScheme ? PDFLib.rgb(0.9, 0.95, 1) : PDFLib.rgb(0.95, 0.95, 0.95);
            accentColor = useColorScheme ? PDFLib.rgb(0.1, 0.6, 0.9) : PDFLib.rgb(0.3, 0.3, 0.3);
            break;
          case 'classic':
            primaryColor = PDFLib.rgb(0.3, 0.2, 0.1);
            secondaryColor = PDFLib.rgb(0.98, 0.96, 0.94);
            accentColor = PDFLib.rgb(0.6, 0.4, 0.2);
            break;
          case 'minimal':
            primaryColor = PDFLib.rgb(0.2, 0.2, 0.2);
            secondaryColor = PDFLib.rgb(1, 1, 1);
            accentColor = PDFLib.rgb(0.5, 0.5, 0.5);
            break;
          case 'professional':
            primaryColor = PDFLib.rgb(0, 0.3, 0.5);
            secondaryColor = PDFLib.rgb(0.97, 0.98, 0.99);
            accentColor = PDFLib.rgb(0, 0.5, 0.8);
            break;
          default:
            primaryColor = PDFLib.rgb(0.1, 0.1, 0.1);
            secondaryColor = PDFLib.rgb(0.95, 0.95, 0.95);
            accentColor = PDFLib.rgb(0.3, 0.3, 0.3);
        }
        
        // Set initial coordinates
        let y = 800;
        
        // Add watermark if enabled
        if (addWatermark) {
          statusMessage.textContent = "Adding watermark...";
          progressBar.style.width = "15%";
          
          const watermarkText = isPaid ? "PAID" : "UNPAID";
          const watermarkColor = isPaid ? 
            PDFLib.rgb(0.2, 0.8, 0.3, 0.1) : 
            PDFLib.rgb(0.8, 0.2, 0.2, 0.1);
          
          page.drawText(watermarkText, {
            x: 200,
            y: 400,
            size: 80,
            font: helveticaBoldFont,
            color: watermarkColor,
            rotate: PDFLib.degrees(45),
          });
        }
        
        // Add header with logo or text
        statusMessage.textContent = "Creating header...";
        progressBar.style.width = "25%";
        
        // Draw header background based on template
        if (selectedTemplate === 'modern' || selectedTemplate === 'professional') {
          page.drawRectangle({
            x: 0,
            y: 750,
            width: 595.28,
            height: 80,
            color: primaryColor,
          });
        }
        
        // Try to load logo if enabled
        let logoImage = null;
        if (addLogo) {
          try {
            const logoImageUrl = 'myrtille_logo.png';
            const logoImageBytes = await fetch(logoImageUrl)
              .then(res => {
                if (!res.ok) throw new Error('Logo image not found');
                return res.arrayBuffer();
              });
            logoImage = await pdfDoc.embedPng(logoImageBytes);
            
            // Draw logo
            const logoDims = logoImage.scale(0.15);
            page.drawImage(logoImage, {
              x: 50,
              y: 770 - logoDims.height,
              width: logoDims.width,
              height: logoDims.height,
            });
            
            y = 770 - logoDims.height - 10;
          } catch (error) {
            console.log('Logo not found, using text:', error);
            addLogo = false;
          }
        }
        
        if (!addLogo) {
          // Draw company name as text
          page.drawText("MYRTILLE INDUSTRIES", {
            x: 50,
            y: selectedTemplate === 'minimal' ? 780 : 780,
            size: selectedTemplate === 'minimal' ? 20 : 24,
            font: helveticaBoldFont,
            color: selectedTemplate === 'modern' || selectedTemplate === 'professional' ? 
                   PDFLib.rgb(1, 1, 1) : primaryColor,
          });
          
          y = 760;
        }
        
        // Add company details
        const companyDetails = [
          "25 Deep Nagar, Near Gurjar ki Thari, Jaipur (Raj) 302019",
          "Phone: 9782099489 | Email: myrtilleindia@gmail.com",
          "GSTIN: 08AMHPY5013C1Z4 | State: 08-Rajasthan",
          "Account No.: 921020038756944 | IFSC: UTIB0002582 | Axis Bank, Swej Farm, Jaipur"
        ];
        
        let detailY = y;
        companyDetails.forEach(detail => {
          page.drawText(detail, {
            x: 50,
            y: detailY,
            size: 8,
            font: helveticaFont,
            color: selectedTemplate === 'modern' || selectedTemplate === 'professional' ? 
                   PDFLib.rgb(0.9, 0.9, 0.9) : PDFLib.rgb(0.3, 0.3, 0.3),
          });
          detailY -= 12;
        });
        
        y = detailY - 20;
        
        // Add invoice title and details
        statusMessage.textContent = "Adding invoice details...";
        progressBar.style.width = "35%";
        
        // Draw invoice title with style based on template
        const titleBackgroundHeight = selectedTemplate === 'modern' ? 40 : 30;
        const titleY = y;
        
        if (selectedTemplate !== 'minimal') {
          page.drawRectangle({
            x: 0,
            y: titleY,
            width: 595.28,
            height: titleBackgroundHeight,
            color: selectedTemplate === 'modern' || selectedTemplate === 'professional' ? 
                   accentColor : secondaryColor,
          });
        }
        
        page.drawText("TAX INVOICE", {
          x: 50,
          y: titleY + (selectedTemplate === 'minimal' ? 5 : 12),
          size: selectedTemplate === 'minimal' ? 18 : 20,
          font: helveticaBoldFont,
          color: selectedTemplate === 'minimal' ? primaryColor : PDFLib.rgb(1, 1, 1),
        });
        
        // Add invoice number and dates on right
        const invoiceNumber = document.getElementById('invoiceNumber').value;
        const invoiceDate = document.getElementById('invoiceDate').value;
        const dueDate = document.getElementById('dueDate').value;
        
        const detailsRightX = 400;
        let detailsRightY = titleY + 15;
        
        page.drawText(`Invoice No: ${invoiceNumber}`, {
          x: detailsRightX,
          y: detailsRightY,
          size: 10,
          font: helveticaBoldFont,
          color: selectedTemplate === 'minimal' ? primaryColor : PDFLib.rgb(1, 1, 1),
        });
        
        detailsRightY -= 15;
        
        page.drawText(`Invoice Date: ${formatDate(invoiceDate)}`, {
          x: detailsRightX,
          y: detailsRightY,
          size: 9,
          font: helveticaFont,
          color: selectedTemplate === 'minimal' ? PDFLib.rgb(0.3, 0.3, 0.3) : PDFLib.rgb(0.9, 0.9, 0.9),
        });
        
        detailsRightY -= 12;
        
        if (dueDate) {
          page.drawText(`Due Date: ${formatDate(dueDate)}`, {
            x: detailsRightX,
            y: detailsRightY,
            size: 9,
            font: helveticaFont,
            color: selectedTemplate === 'minimal' ? PDFLib.rgb(0.3, 0.3, 0.3) : PDFLib.rgb(0.9, 0.9, 0.9),
          });
          detailsRightY -= 12;
        }
        
        const poNumber = document.getElementById('poNumber').value;
        if (poNumber) {
          page.drawText(`PO Number: ${poNumber}`, {
            x: detailsRightX,
            y: detailsRightY,
            size: 9,
            font: helveticaFont,
            color: selectedTemplate === 'minimal' ? PDFLib.rgb(0.3, 0.3, 0.3) : PDFLib.rgb(0.9, 0.9, 0.9),
          });
        }
        
        y = titleY - titleBackgroundHeight - 20;
        
        // Add bill to section
        const customerName = document.getElementById('customerName').value;
        const customerAddress = document.getElementById('customerAddress').value;
        const customerContact = document.getElementById('customerContact').value;
        const customerEmail = document.getElementById('customerEmail').value;
        const customerGST = document.getElementById('customerGST').value;
        const customerState = document.getElementById('customerState').value;
        
        page.drawText("BILL TO:", {
          x: 50,
          y: y,
          size: 11,
          font: helveticaBoldFont,
          color: primaryColor,
        });
        
        y -= 15;
        
        page.drawText(customerName, {
          x: 50,
          y: y,
          size: 10,
          font: helveticaBoldFont,
          color: PDFLib.rgb(0.1, 0.1, 0.1),
        });
        
        y -= 12;
        
        // Split address if too long
        const addressLines = splitText(customerAddress, 60);
        addressLines.forEach(line => {
          page.drawText(line, {
            x: 50,
            y: y,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          y -= 10;
        });
        
        page.drawText(`Contact: ${customerContact}`, {
          x: 50,
          y: y,
          size: 9,
          font: helveticaFont,
          color: PDFLib.rgb(0.3, 0.3, 0.3),
        });
        
        y -= 10;
        
        if (customerEmail) {
          page.drawText(`Email: ${customerEmail}`, {
            x: 50,
            y: y,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          y -= 10;
        }
        
        if (customerGST) {
          page.drawText(`GSTIN: ${customerGST}`, {
            x: 50,
            y: y,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          y -= 10;
        }
        
        if (customerState) {
          page.drawText(`State Code: ${customerState}`, {
            x: 50,
            y: y,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          y -= 10;
        }
        
        y -= 20;
        
        // Add items table
        statusMessage.textContent = "Adding invoice items...";
        progressBar.style.width = "50%";
        
        const tableHeaders = ["#", "Item Description", "HSN/SAC", "Qty", "Unit Price", "GST %", "Amount"];
        const columnWidths = [25, 200, 60, 40, 70, 50, 80];
        const tableStartY = y;
        let tableEndY = y;
        
        // Draw table header background
        page.drawRectangle({
          x: 45,
          y: y - 5,
          width: 505,
          height: 25,
          color: selectedTemplate === 'minimal' ? PDFLib.rgb(0.95, 0.95, 0.95) : accentColor,
          borderColor: primaryColor,
          borderWidth: 1,
        });
        
        // Draw table headers
        let x = 50;
        tableHeaders.forEach((header, index) => {
          page.drawText(header, {
            x: x,
            y: y,
            size: 9,
            font: helveticaBoldFont,
            color: selectedTemplate === 'minimal' ? primaryColor : PDFLib.rgb(1, 1, 1),
          });
          x += columnWidths[index];
        });
        
        y -= 25;
        tableEndY = y;
        
        // Add table rows
        const rows = document.querySelectorAll('#itemsTableBody tr');
        const totals = calculateInvoiceTotals();
        
        rows.forEach((row, index) => {
          const name = row.querySelector('.item-name').value;
          const hsn = row.querySelector('.item-hsn').value;
          const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
          const price = parseFloat(row.querySelector('.item-price').value) || 0;
          const gst = parseFloat(row.querySelector('.item-gst').value) || 0;
          
          const subtotal = quantity * price;
          const gstAmount = subtotal * (gst / 100);
          const total = subtotal + gstAmount;
          
          // Draw row background for alternate rows
          if (index % 2 === 0 && selectedTemplate !== 'minimal') {
            page.drawRectangle({
              x: 45,
              y: y - 15,
              width: 505,
              height: 20,
              color: PDFLib.rgb(0.98, 0.98, 0.98),
            });
          }
          
          // Draw row data
          x = 50;
          
          page.drawText((index + 1).toString(), {
            x: x,
            y: y,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          x += columnWidths[0];
          
          // Split item name if too long
          const itemLines = splitText(name, 30);
          itemLines.forEach((line, lineIndex) => {
            page.drawText(line, {
              x: x,
              y: y - (lineIndex * 10),
              size: 9,
              font: helveticaFont,
              color: PDFLib.rgb(0.1, 0.1, 0.1),
            });
          });
          x += columnWidths[1];
          
          page.drawText(hsn, {
            x: x,
            y: y,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          x += columnWidths[2];
          
          page.drawText(quantity.toString(), {
            x: x,
            y: y,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          x += columnWidths[3];
          
          page.drawText(`Rs. ${price.toFixed(2)}`, {
            x: x,
            y: y,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          x += columnWidths[4];
          
          page.drawText(`${gst}%`, {
            x: x,
            y: y,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          x += columnWidths[5];
          
          page.drawText(`Rs. ${total.toFixed(2)}`, {
            x: x,
            y: y,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          
          y -= 20;
          tableEndY = y;
          
          // If item name had multiple lines, adjust for next row
          if (itemLines.length > 1) {
            y -= (itemLines.length - 1) * 10;
            tableEndY = y;
          }
        });
        
        // Draw table bottom border
        page.drawLine({
          start: { x: 45, y: tableEndY + 5 },
          end: { x: 550, y: tableEndY + 5 },
          thickness: 1,
          color: primaryColor,
        });
        
        y = tableEndY - 20;
        
        // Add totals section
        statusMessage.textContent = "Calculating totals...";
        progressBar.style.width = "70%";
        
        const amountReceived = parseFloat(document.getElementById('amountReceived').value) || 0;
        const balance = parseFloat(totals.totalAmount) - amountReceived;
        const paymentMode = document.getElementById('paymentMode').value;
        
        // Draw totals box
        const totalsBoxWidth = 250;
        const totalsBoxX = 550 - totalsBoxWidth;
        
        page.drawRectangle({
          x: totalsBoxX - 10,
          y: y - 140,
          width: totalsBoxWidth,
          height: 150,
          color: PDFLib.rgb(0.98, 0.98, 0.98),
          borderColor: primaryColor,
          borderWidth: 1,
        });
        
        let totalsY = y;
        
        const totalsData = [
          ["Sub Total", `Rs. ${totals.subtotal}`],
          ["Discount", `- Rs. ${totals.discount}`],
          ["Shipping", `+ Rs. ${totals.shipping}`],
        ];
        
        // Add GST breakdown
        if (totals.isSameState) {
          totalsData.push(["CGST @9%", `Rs. ${totals.cgst}`]);
          totalsData.push(["SGST @9%", `Rs. ${totals.sgst}`]);
        } else {
          totalsData.push(["IGST @18%", `Rs. ${totals.igst}`]);
        }
        
        totalsData.push(
          ["Total Amount", `Rs. ${totals.totalAmount}`],
          ["Amount Received", `- Rs. ${amountReceived.toFixed(2)}`],
          ["Balance Due", `Rs. ${balance.toFixed(2)}`]
        );
        
        totalsData.forEach(([label, value], index) => {
          const isTotal = label === "Total Amount" || label === "Balance Due";
          
          page.drawText(label, {
            x: totalsBoxX,
            y: totalsY,
            size: isTotal ? 10 : 9,
            font: isTotal ? helveticaBoldFont : helveticaFont,
            color: isTotal ? primaryColor : PDFLib.rgb(0.3, 0.3, 0.3),
          });
          
          page.drawText(value, {
            x: totalsBoxX + 150,
            y: totalsY,
            size: isTotal ? 10 : 9,
            font: isTotal ? helveticaBoldFont : helveticaFont,
            color: isTotal ? primaryColor : PDFLib.rgb(0.3, 0.3, 0.3),
          });
          
          totalsY -= isTotal ? 15 : 12;
          
          // Add line after total
          if (label === "Total Amount") {
            page.drawLine({
              start: { x: totalsBoxX, y: totalsY + 5 },
              end: { x: totalsBoxX + 180, y: totalsY + 5 },
              thickness: 0.5,
              color: PDFLib.rgb(0.5, 0.5, 0.5),
            });
            totalsY -= 5;
          }
        });
        
        // Add amount in words on left side
        const amountWords = numberToWords(totals.totalAmount);
        const wordsLines = splitText(`Amount in Words: ${amountWords}`, 70);
        
        let wordsY = y;
        wordsLines.forEach(line => {
          page.drawText(line, {
            x: 50,
            y: wordsY,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          wordsY -= 12;
        });
        
        y = totalsY - 20;
        
        // Add payment details
        statusMessage.textContent = "Adding payment details...";
        progressBar.style.width = "85%";
        
        page.drawText("PAYMENT DETAILS:", {
          x: 50,
          y: y,
          size: 10,
          font: helveticaBoldFont,
          color: primaryColor,
        });
        
        y -= 15;
        
        page.drawText(`Payment Mode: ${paymentMode}`, {
          x: 50,
          y: y,
          size: 9,
          font: helveticaFont,
          color: PDFLib.rgb(0.3, 0.3, 0.3),
        });
        
        y -= 12;
        
        if (paymentMode === "Bank Transfer") {
          const bankDetails = document.getElementById('bankDetails').value;
          const bankLines = splitText(bankDetails, 60);
          
          bankLines.forEach(line => {
            page.drawText(line, {
              x: 50,
              y: y,
              size: 9,
              font: helveticaFont,
              color: PDFLib.rgb(0.3, 0.3, 0.3),
            });
            y -= 10;
          });
        }
        
        // Add QR code if enabled
        if (addQRCode) {
          const qrCode = await generateQRCode(pdfDoc);
          if (qrCode) {
            page.drawImage(qrCode, {
              x: 450,
              y: 100,
              width: 80,
              height: 80,
            });
            
            page.drawText("Scan to Pay", {
              x: 455,
              y: 95,
              size: 8,
              font: helveticaFont,
              color: PDFLib.rgb(0.3, 0.3, 0.3),
            });
          }
        }
        
        // Add terms and conditions
        const terms = document.getElementById('terms').value;
        const termsLines = splitText(`Terms & Conditions: ${terms}`, 90);
        
        let termsY = 120;
        termsLines.forEach(line => {
          page.drawText(line, {
            x: 50,
            y: termsY,
            size: 8,
            font: helveticaFont,
            color: PDFLib.rgb(0.4, 0.4, 0.4),
          });
          termsY -= 10;
        });
        
        // Add notes if any
        const notes = document.getElementById('notes').value;
        if (notes) {
          const notesLines = splitText(`Notes: ${notes}`, 90);
          
          notesLines.forEach(line => {
            page.drawText(line, {
              x: 50,
              y: termsY,
              size: 8,
              font: helveticaFont,
              color: PDFLib.rgb(0.4, 0.4, 0.4),
            });
            termsY -= 10;
          });
        }
        
        // Add signature section
        statusMessage.textContent = "Adding signature...";
        progressBar.style.width = "95%";
        
        try {
          // Try to load the signature image
          const signatureImageUrl = 'myrtille_signature.png';
          const signatureImageBytes = await fetch(signatureImageUrl)
            .then(res => {
              if (!res.ok) throw new Error('Signature image not found');
              return res.arrayBuffer();
            });
          
          const signatureImage = await pdfDoc.embedPng(signatureImageBytes);
          const signatureDims = signatureImage.scale(0.2);
          
          page.drawImage(signatureImage, {
            x: 400,
            y: 80,
            width: signatureDims.width,
            height: signatureDims.height,
          });
          
          page.drawText("For Myrtille Industries", {
            x: 400,
            y: 65,
            size: 10,
            font: helveticaBoldFont,
            color: primaryColor,
          });
          
          page.drawText("Authorized Signatory", {
            x: 400,
            y: 50,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
        } catch (error) {
          console.log('Signature image not found, using text instead');
          
          page.drawText("_________________________", {
            x: 400,
            y: 80,
            size: 12,
            font: helveticaFont,
            color: PDFLib.rgb(0.5, 0.5, 0.5),
          });
          
          page.drawText("For Myrtille Industries", {
            x: 400,
            y: 65,
            size: 10,
            font: helveticaBoldFont,
            color: primaryColor,
          });
          
          page.drawText("Authorized Signatory", {
            x: 400,
            y: 50,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
        }
        
        // Add footer
        page.drawText("Thank you for your business!", {
          x: 200,
          y: 30,
          size: 10,
          font: helveticaObliqueFont,
          color: accentColor,
        });
        
        page.drawText("Software Generated Invoice | Myrtille Industries Invoice System", {
          x: 150,
          y: 15,
          size: 7,
          font: helveticaFont,
          color: PDFLib.rgb(0.5, 0.5, 0.5),
        });
        
        // Save PDF
        statusMessage.textContent = "Finalizing PDF...";
        progressBar.style.width = "100%";
        
        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        
        // Generate filename
        const invoiceNumberClean = invoiceNumber.replace(/[^a-zA-Z0-9]/g, '_');
        const filename = `Myrtille_Invoice_${invoiceNumberClean}_${selectedTemplate}.pdf`;
        
        // Save file
        saveAs(blob, filename);
        
        statusMessage.textContent = "Invoice generated successfully!";
        
        setTimeout(() => {
          statusArea.classList.remove('active');
          successMessage.style.display = 'block';
          setTimeout(() => {
            successMessage.style.display = 'none';
          }, 4000);
        }, 1000);
        
      } catch (error) {
        console.error('Error generating PDF:', error);
        document.getElementById('errorText').textContent = `Error generating PDF: ${error.message}`;
        errorMessage.style.display = 'block';
        statusArea.classList.remove('active');
      }
    }
    
    // Helper function to format date
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-IN', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    }
    
    // Helper function to split text into lines
    function splitText(text, maxLength) {
      const words = text.split(' ');
      const lines = [];
      let currentLine = '';
      
      words.forEach(word => {
        if ((currentLine + ' ' + word).length <= maxLength) {
          currentLine += (currentLine ? ' ' : '') + word;
        } else {
          if (currentLine) lines.push(currentLine);
          currentLine = word;
        }
      });
      
      if (currentLine) lines.push(currentLine);
      return lines;
    }
    
    // Function to reset form
    function resetForm() {
      if (confirm("Are you sure you want to reset the form? All data will be lost.")) {
        document.getElementById('invoiceForm').reset();
        
        // Reset dates
        const today = new Date();
        const dueDate = new Date();
        dueDate.setDate(today.getDate() + 30);
        
        document.getElementById('invoiceDate').value = today.toISOString().split('T')[0];
        document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
        
        // Reset items table
        document.getElementById('itemsTableBody').innerHTML = '';
        addItemRow();
        
        // Reset toggles
        document.getElementById('logoToggle').classList.remove('active');
        document.getElementById('watermarkToggle').classList.remove('active');
        document.getElementById('qrCodeToggle').classList.remove('active');
        document.getElementById('colorSchemeToggle').classList.remove('active');
        document.getElementById('paidStatus').checked = true;
        
        // Reset template
        selectTemplate('modern');
        
        // Add sample data
        addSampleData();
      }
    }
    
    // Function to save as template
    function saveTemplate() {
      alert('Template saved! In a real application, this would save your current form data as a template for future use.');
    }
    
    // Function to add sample data for demo
    function addSampleData() {
      // Set sample customer data
      document.getElementById('customerName').value = "SUPERINTENDENT CUM MEMBER SECRETARY RMRS";
      document.getElementById('customerAddress').value = "SUPER SPECIALITY HOSPITAL, RNT MEDICAL COLLEGE, UDAIPUR";
      document.getElementById('customerContact').value = "9829851042";
      
      // Clear any existing rows and add sample item
      document.getElementById('itemsTableBody').innerHTML = '';
      addItemRow({
        name: "RAT AND PEST CONTROL SERVICES - ANNUAL CONTRACT",
        hsn: "999311",
        quantity: 1,
        price: 35416,
        gst: 18
      });
      
      // Add another sample item
      addItemRow({
        name: "SANITIZATION AND DISINFECTION SERVICES",
        hsn: "999312",
        quantity: 4,
        price: 2500,
        gst: 18
      });
    }
  </script>
</body>
</html>
