<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Myrtille Industries - Professional Invoice Generator</title>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height: 100vh;
      color: #f0f0f0;
      background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('https://4kwallpapers.com/images/wallpapers/macos-big-sur-apple-layers-fluidic-colorful-wwdc-stock--1455.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      padding: 20px;
    }

    .main-container {
      max-width: 800px;
      margin: 0 auto;
    }

    /* Form Container */
    .form-container {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(16px);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2), 0 4px 16px rgba(255, 255, 255, 0.1), inset 0 1px 2px rgba(255, 255, 255, 0.3);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 30px;
    }

    .header {
      padding-bottom: 24px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      margin-bottom: 24px;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 600;
      color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .header h1 i {
      color: #5b86e5;
      font-size: 28px;
    }

    .header p {
      color: rgba(255, 255, 255, 0.8);
      margin-top: 8px;
      font-size: 16px;
    }

    /* Form Styles */
    .form-section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #5b86e5;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      font-size: 18px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .form-group {
      margin-bottom: 18px;
    }

    .form-group label {
      display: block;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
    }

    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 14px 16px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      font-size: 15px;
      transition: all 0.3s ease;
    }

    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: #5b86e5;
      box-shadow: 0 0 0 2px rgba(91, 134, 229, 0.3);
      background: rgba(255, 255, 255, 0.2);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Items Table */
    .items-table-container {
      overflow-x: auto;
      margin-bottom: 20px;
    }

    .items-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
    }

    .items-table th {
      background: rgba(91, 134, 229, 0.3);
      color: #fff;
      font-weight: 600;
      padding: 14px 12px;
      text-align: left;
      font-size: 14px;
    }

    .items-table td {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .items-table input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
    }

    .items-table input:focus {
      outline: none;
      border-color: #5b86e5;
    }

    .item-actions {
      display: flex;
      gap: 8px;
    }

    /* Buttons */
    .btn {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(12px);
      color: #f0f0f0;
      border: 1px solid rgba(255, 255, 255, 0.4);
      padding: 14px 24px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 8px 24px rgba(91, 134, 229, 0.4), 0 4px 12px rgba(0, 0, 0, 0.2), inset 0 2px 4px rgba(255, 255, 255, 0.3);
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(91, 134, 229, 0.5), 0 6px 16px rgba(0, 0, 0, 0.3), inset 0 2px 4px rgba(255, 255, 255, 0.4);
    }

    .btn-primary {
      background: rgba(91, 134, 229, 0.7);
      border-color: #5b86e5;
    }

    .btn-primary:hover {
      background: rgba(91, 134, 229, 0.9);
    }

    .btn-secondary {
      background: rgba(52, 199, 89, 0.3);
      border-color: #34c759;
    }

    .btn-secondary:hover {
      background: rgba(52, 199, 89, 0.5);
    }

    .btn-danger {
      background: rgba(255, 59, 48, 0.3);
      border-color: #ff3b30;
    }

    .btn-danger:hover {
      background: rgba(255, 59, 48, 0.5);
    }

    .btn-small {
      padding: 8px 12px;
      font-size: 13px;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    /* Status Area */
    .status-area {
      display: none;
      margin-top: 24px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .status-area.active {
      display: block;
    }

    .status-header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }

    .status-header i {
      margin-right: 12px;
      color: #5b86e5;
      font-size: 20px;
    }

    .status-header h3 {
      font-size: 18px;
      font-weight: 500;
      color: #f0f0f0;
    }

    .progress-container {
      background: rgba(255, 255, 255, 0.1);
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, #5b86e5, #36d1dc);
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    .status-message {
      margin-top: 12px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
    }

    .success-message, .error-message {
      display: none;
      padding: 16px;
      border-radius: 12px;
      font-size: 14px;
      text-align: center;
      margin-top: 24px;
    }

    .success-message {
      background: rgba(52, 199, 89, 0.2);
      color: #34c759;
      border: 1px solid rgba(52, 199, 89, 0.3);
    }

    .error-message {
      background: rgba(255, 59, 48, 0.2);
      color: #ff3b30;
      border: 1px solid rgba(255, 59, 48, 0.3);
    }

    .success-message i, .error-message i {
      margin-right: 8px;
    }

    /* Back Button */
    .back-button {
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 2147483647;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.55), rgba(255, 255, 255, 0.15));
      backdrop-filter: blur(14px) saturate(160%);
      -webkit-backdrop-filter: blur(14px) saturate(160%);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18), inset 0 1px 1px rgba(255, 255, 255, 0.7);
      transition: transform .35s cubic-bezier(.2, .8, .2, 1), box-shadow .35s cubic-bezier(.2, .8, .2, 1);
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    .back-button:hover {
      transform: translateY(-4px) scale(1.05);
      box-shadow: 0 18px 45px rgba(0, 0, 0, .28), inset 0 1px 1px rgba(255, 255, 255, .85);
    }

    .back-button:hover svg {
      transform: rotate(360deg);
    }

    .back-button svg {
      position: relative;
      z-index: 2;
      transition: transform .35s ease;
    }

    .back-button span {
      position: absolute;
      inset: -6px;
      border-radius: 50%;
      background: conic-gradient(from 0deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, .6), rgba(255, 255, 255, 0));
      filter: blur(8px);
      opacity: .6;
      animation: spin 6s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Back Button -->
  <button class="back-button" onclick="history.back()">
    <span></span>
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M15 18l-6-6 6-6" stroke="rgba(20,20,20,.9)" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <div class="main-container">
    <!-- Form Container -->
    <div class="form-container">
      <div class="header">
        <h1><i class="fas fa-file-invoice"></i> Myrtille Industries Invoice Generator</h1>
        <p>Professional invoice generator with modern templates</p>
      </div>

      <form id="invoiceForm">
        <!-- Company Details -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-building"></i>
            <span>Company Details</span>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="invoiceNumber">Invoice Number</label>
              <input type="text" id="invoiceNumber" value="INV-2024-001" required>
            </div>
            
            <div class="form-group">
              <label for="invoiceDate">Invoice Date</label>
              <input type="date" id="invoiceDate" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="dueDate">Due Date</label>
              <input type="date" id="dueDate">
            </div>
            
            <div class="form-group">
              <label for="poNumber">PO Number (Optional)</label>
              <input type="text" id="poNumber">
            </div>
          </div>
        </div>

        <!-- Bill To Section -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-user-tie"></i>
            <span>Bill To</span>
          </div>
          
          <div class="form-group">
            <label for="customerName">Customer Name</label>
            <input type="text" id="customerName" value="SUPERINTENDENT CUM MEMBER SECRETARY RMRS" required>
          </div>
          
          <div class="form-group">
            <label for="customerAddress">Customer Address</label>
            <textarea id="customerAddress" required>SUPER SPECIALITY HOSPITAL, RNT MEDICAL COLLEGE, UDAIPUR</textarea>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="customerContact">Contact No.</label>
              <input type="text" id="customerContact" value="9829851042" required>
            </div>
            
            <div class="form-group">
              <label for="customerEmail">Email (Optional)</label>
              <input type="email" id="customerEmail">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="customerGST">Customer GSTIN (Optional)</label>
              <input type="text" id="customerGST">
            </div>
            
            <div class="form-group">
              <label for="customerState">State Code (Optional)</label>
              <input type="text" id="customerState" placeholder="e.g., 08">
            </div>
          </div>
        </div>

        <!-- Items Section -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-list"></i>
            <span>Invoice Items</span>
          </div>
          
          <div class="items-table-container">
            <table class="items-table" id="itemsTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Item Name</th>
                  <th>HSN/SAC</th>
                  <th>Qty</th>
                  <th>Price/Unit (Rs.)</th>
                  <th>GST %</th>
                  <th>Amount (Rs.)</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="itemsTableBody">
                <!-- Items will be added here dynamically -->
              </tbody>
            </table>
          </div>
          
          <button type="button" class="btn btn-secondary" id="addItemBtn">
            <i class="fas fa-plus"></i> Add Item
          </button>
          
          <div class="form-row" style="margin-top: 20px;">
            <div class="form-group">
              <label for="discount">Discount (Rs.)</label>
              <input type="number" id="discount" value="0" min="0" step="0.01">
            </div>
            
            <div class="form-group">
              <label for="shipping">Shipping Charges (Rs.)</label>
              <input type="number" id="shipping" value="0" min="0" step="0.01">
            </div>
          </div>
        </div>

        <!-- Payment Details -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-rupee-sign"></i>
            <span>Payment Details</span>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="amountReceived">Amount Received (Rs.)</label>
              <input type="number" id="amountReceived" value="0" min="0" step="0.01">
            </div>
            
            <div class="form-group">
              <label for="paymentMode">Payment Mode</label>
              <select id="paymentMode">
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Cash">Cash</option>
                <option value="Cheque">Cheque</option>
                <option value="Online">Online</option>
                <option value="UPI">UPI</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label for="terms">Terms and Conditions (One Line)</label>
            <textarea id="terms" rows="2">Payment due within 30 days of invoice date. Late payment interest @18% p.a.</textarea>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="button-group">
          <button type="button" class="btn btn-primary" id="generateInvoiceBtn">
            <i class="fas fa-file-pdf"></i> Generate Invoice PDF
          </button>
          
          <button type="button" class="btn btn-danger" id="resetFormBtn">
            <i class="fas fa-redo"></i> Reset Form
          </button>
        </div>
      </form>

      <!-- Status Area -->
      <div class="status-area" id="statusArea">
        <div class="status-header">
          <i class="fas fa-cog fa-spin"></i>
          <h3>Generating your invoice...</h3>
        </div>
        <div class="progress-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="status-message" id="statusMessage">Initializing PDF generation...</div>
      </div>

      <!-- Success/Error Messages -->
      <div class="success-message" id="successMessage">
        <i class="fas fa-check-circle"></i> Invoice generated successfully!
      </div>
      
      <div class="error-message" id="errorMessage">
        <i class="fas fa-exclamation-circle"></i> <span id="errorText">Error generating invoice</span>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize date fields
      const today = new Date();
      const dueDate = new Date();
      dueDate.setDate(today.getDate() + 30);
      
      document.getElementById('invoiceDate').value = today.toISOString().split('T')[0];
      document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
      
      // Add initial item row
      addItemRow();
      
      // Set up event listeners
      document.getElementById('addItemBtn').addEventListener('click', addItemRow);
      document.getElementById('generateInvoiceBtn').addEventListener('click', generateInvoicePDF);
      document.getElementById('resetFormBtn').addEventListener('click', resetForm);
      
      // Add sample data for demo
      addSampleData();
    });
    
    // Function to add a new item row
    function addItemRow(itemData = {}) {
      const tbody = document.getElementById('itemsTableBody');
      const rowCount = tbody.children.length + 1;
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${rowCount}</td>
        <td><input type="text" class="item-name" value="${itemData.name || ''}" placeholder="Item name"></td>
        <td><input type="text" class="item-hsn" value="${itemData.hsn || ''}" placeholder="HSN/SAC code"></td>
        <td><input type="number" class="item-quantity" value="${itemData.quantity || 1}" min="1" step="1"></td>
        <td><input type="number" class="item-price" value="${itemData.price || 0}" min="0" step="0.01"></td>
        <td>
          <select class="item-gst">
            <option value="0" ${itemData.gst === 0 ? 'selected' : ''}>0%</option>
            <option value="5" ${itemData.gst === 5 ? 'selected' : ''}>5%</option>
            <option value="12" ${itemData.gst === 12 ? 'selected' : ''}>12%</option>
            <option value="18" ${itemData.gst === 18 ? 'selected' : ''}>18%</option>
            <option value="28" ${itemData.gst === 28 ? 'selected' : ''}>28%</option>
          </select>
        </td>
        <td class="item-amount">Rs. 0.00</td>
        <td>
          <div class="item-actions">
            <button type="button" class="btn btn-small" onclick="calculateItemAmount(this)">
              <i class="fas fa-calculator"></i>
            </button>
            <button type="button" class="btn btn-small btn-danger" onclick="removeItemRow(this)">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      `;
      
      tbody.appendChild(row);
      
      // Add event listeners to inputs for auto-calculation
      const inputs = row.querySelectorAll('.item-quantity, .item-price, .item-gst');
      inputs.forEach(input => {
        input.addEventListener('input', () => calculateItemAmount(row));
      });
      
      // Calculate initial amount
      calculateItemAmount(row);
    }
    
    // Function to calculate item amount
    function calculateItemAmount(element) {
      const row = element.closest ? element.closest('tr') : element;
      const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
      const price = parseFloat(row.querySelector('.item-price').value) || 0;
      const gst = parseFloat(row.querySelector('.item-gst').value) || 0;
      
      const subtotal = quantity * price;
      const gstAmount = subtotal * (gst / 100);
      const total = subtotal + gstAmount;
      
      row.querySelector('.item-amount').textContent = `Rs. ${total.toFixed(2)}`;
      
      // Update the row number if needed
      updateRowNumbers();
    }
    
    // Function to remove an item row
    function removeItemRow(button) {
      const row = button.closest('tr');
      row.remove();
      updateRowNumbers();
    }
    
    // Function to update row numbers
    function updateRowNumbers() {
      const rows = document.querySelectorAll('#itemsTableBody tr');
      rows.forEach((row, index) => {
        row.querySelector('td:first-child').textContent = index + 1;
      });
    }
    
    // Function to calculate invoice totals
    function calculateInvoiceTotals() {
      const rows = document.querySelectorAll('#itemsTableBody tr');
      let subtotal = 0;
      let totalGST = 0;
      let totalAmount = 0;
      let cgst = 0;
      let sgst = 0;
      let igst = 0;
      
      // Check if customer is in same state (Rajasthan - 08)
      const customerState = document.getElementById('customerState').value;
      const isSameState = customerState === '08' || customerState === '' || !customerState;
      
      rows.forEach(row => {
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        const gst = parseFloat(row.querySelector('.item-gst').value) || 0;
        
        const itemSubtotal = quantity * price;
        const itemGST = itemSubtotal * (gst / 100);
        
        subtotal += itemSubtotal;
        totalGST += itemGST;
        
        if (isSameState) {
          // CGST and SGST split equally
          cgst += itemGST / 2;
          sgst += itemGST / 2;
        } else {
          // IGST
          igst += itemGST;
        }
      });
      
      totalAmount = subtotal + totalGST;
      
      // Apply discount and shipping
      const discount = parseFloat(document.getElementById('discount').value) || 0;
      const shipping = parseFloat(document.getElementById('shipping').value) || 0;
      
      totalAmount = totalAmount - discount + shipping;
      
      return {
        subtotal: subtotal.toFixed(2),
        totalGST: totalGST.toFixed(2),
        cgst: cgst.toFixed(2),
        sgst: sgst.toFixed(2),
        igst: igst.toFixed(2),
        discount: discount.toFixed(2),
        shipping: shipping.toFixed(2),
        totalAmount: totalAmount.toFixed(2),
        isSameState: isSameState
      };
    }
    
    // Function to convert number to words (only rupees part)
    function numberToWords(num) {
      const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
      const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
      
      const number = parseFloat(num);
      const rupees = Math.floor(number); // Only rupees part
      
      if (rupees === 0) {
        return 'Zero Rupees only';
      }
      
      let rupeesWords = '';
      
      // Convert crore part
      const crore = Math.floor(rupees / 10000000);
      if (crore > 0) {
        rupeesWords += numberToWordsForPart(crore) + 'crore ';
      }
      
      // Convert lakh part
      const lakh = Math.floor((rupees % 10000000) / 100000);
      if (lakh > 0) {
        rupeesWords += numberToWordsForPart(lakh) + 'lakh ';
      }
      
      // Convert thousand part
      const thousand = Math.floor((rupees % 100000) / 1000);
      if (thousand > 0) {
        rupeesWords += numberToWordsForPart(thousand) + 'thousand ';
      }
      
      // Convert hundred part
      const hundred = Math.floor((rupees % 1000) / 100);
      if (hundred > 0) {
        rupeesWords += numberToWordsForPart(hundred) + 'hundred ';
      }
      
      // Convert tens and units
      const tensAndUnits = rupees % 100;
      if (tensAndUnits > 0) {
        if (rupeesWords !== '') {
          rupeesWords += 'and ';
        }
        rupeesWords += numberToWordsForPart(tensAndUnits);
      }
      
      return rupeesWords.trim().charAt(0).toUpperCase() + rupeesWords.trim().slice(1) + ' Rupees only';
    }
    
    // Helper function for number to words conversion
    function numberToWordsForPart(num) {
      const a = ['', 'one ', 'two ', 'three ', 'four ', 'five ', 'six ', 'seven ', 'eight ', 'nine ', 'ten ', 'eleven ', 'twelve ', 'thirteen ', 'fourteen ', 'fifteen ', 'sixteen ', 'seventeen ', 'eighteen ', 'nineteen '];
      const b = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
      
      if (num < 20) {
        return a[num];
      } else {
        const tens = Math.floor(num / 10);
        const units = num % 10;
        return b[tens] + (units !== 0 ? ' ' + a[units] : '');
      }
    }
    
    // Function to generate invoice PDF
    async function generateInvoicePDF() {
      // Show status
      const statusArea = document.getElementById('statusArea');
      const progressBar = document.getElementById('progressBar');
      const statusMessage = document.getElementById('statusMessage');
      const successMessage = document.getElementById('successMessage');
      const errorMessage = document.getElementById('errorMessage');
      
      successMessage.style.display = 'none';
      errorMessage.style.display = 'none';
      statusArea.classList.add('active');
      statusMessage.textContent = "Starting PDF generation...";
      progressBar.style.width = "10%";
      
      try {
        // Create PDF document
        const pdfDoc = await PDFLib.PDFDocument.create();
        const page = pdfDoc.addPage([595.28, 841.89]); // A4 size
        
        // Load fonts
        const helveticaFont = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
        const helveticaBoldFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
        const helveticaObliqueFont = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaOblique);
        
        // Set initial coordinates
        let y = 820;
        
        // Add company header - centered
        statusMessage.textContent = "Creating header...";
        progressBar.style.width = "20%";
        
        // Company name centered
        page.drawText("MYRTILLE INDUSTRIES", {
          x: 200,
          y: y,
          size: 24,
          font: helveticaBoldFont,
          color: PDFLib.rgb(0.1, 0.1, 0.1),
        });
        
        y -= 25;
        
        // Address centered below company name
        page.drawText("PLOT-25, DEEPNAGAR, NEAR GUJAR KI THADI, JAIPUR, 302019", {
          x: 120,
          y: y,
          size: 10,
          font: helveticaFont,
          color: PDFLib.rgb(0.3, 0.3, 0.3),
        });
        
        y -= 30;
        
        // Draw line separator
        page.drawLine({
          start: { x: 50, y: y },
          end: { x: 545, y: y },
          thickness: 1,
          color: PDFLib.rgb(0.8, 0.8, 0.8),
        });
        
        y -= 20;
        
        // Contact details on left, GST/PAN on right
        page.drawText("Phone: 9782099489", {
          x: 50,
          y: y,
          size: 9,
          font: helveticaFont,
          color: PDFLib.rgb(0.3, 0.3, 0.3),
        });
        
        page.drawText("Email: myrtilleindia@gmail.com", {
          x: 50,
          y: y - 12,
          size: 9,
          font: helveticaFont,
          color: PDFLib.rgb(0.3, 0.3, 0.3),
        });
        
        page.drawText("GSTIN: 08AMHPY5013C1Z4", {
          x: 350,
          y: y,
          size: 9,
          font: helveticaFont,
          color: PDFLib.rgb(0.3, 0.3, 0.3),
        });
        
        page.drawText("PAN: AMHPY5013C", {
          x: 350,
          y: y - 12,
          size: 9,
          font: helveticaFont,
          color: PDFLib.rgb(0.3, 0.3, 0.3),
        });
        
        y -= 40;
        
        // Invoice title
        page.drawText("TAX INVOICE", {
          x: 250,
          y: y,
          size: 18,
          font: helveticaBoldFont,
          color: PDFLib.rgb(0.1, 0.1, 0.1),
        });
        
        y -= 40;
        
        // Bill To section on left
        const customerName = document.getElementById('customerName').value;
        const customerAddress = document.getElementById('customerAddress').value;
        const customerContact = document.getElementById('customerContact').value;
        const customerEmail = document.getElementById('customerEmail').value;
        const customerGST = document.getElementById('customerGST').value;
        
        page.drawText("BILL TO:", {
          x: 50,
          y: y,
          size: 11,
          font: helveticaBoldFont,
          color: PDFLib.rgb(0.2, 0.4, 0.8),
        });
        
        let billY = y - 15;
        
        page.drawText(customerName, {
          x: 50,
          y: billY,
          size: 10,
          font: helveticaBoldFont,
          color: PDFLib.rgb(0.1, 0.1, 0.1),
        });
        
        billY -= 12;
        
        // Split address if too long
        const addressLines = splitText(customerAddress, 40);
        addressLines.forEach(line => {
          page.drawText(line, {
            x: 50,
            y: billY,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          billY -= 10;
        });
        
        if (customerContact) {
          page.drawText(`Contact: ${customerContact}`, {
            x: 50,
            y: billY,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          billY -= 10;
        }
        
        if (customerEmail) {
          page.drawText(`Email: ${customerEmail}`, {
            x: 50,
            y: billY,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          billY -= 10;
        }
        
        if (customerGST) {
          page.drawText(`GSTIN: ${customerGST}`, {
            x: 50,
            y: billY,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
        }
        
        // Invoice details on right
        const invoiceNumber = document.getElementById('invoiceNumber').value;
        const invoiceDate = document.getElementById('invoiceDate').value;
        const dueDate = document.getElementById('dueDate').value;
        const poNumber = document.getElementById('poNumber').value;
        
        let invoiceY = y;
        
        page.drawText("INVOICE DETAILS:", {
          x: 350,
          y: invoiceY,
          size: 11,
          font: helveticaBoldFont,
          color: PDFLib.rgb(0.2, 0.4, 0.8),
        });
        
        invoiceY -= 15;
        
        page.drawText(`Invoice No: ${invoiceNumber}`, {
          x: 350,
          y: invoiceY,
          size: 9,
          font: helveticaFont,
          color: PDFLib.rgb(0.3, 0.3, 0.3),
        });
        
        invoiceY -= 12;
        
        page.drawText(`Invoice Date: ${formatDate(invoiceDate)}`, {
          x: 350,
          y: invoiceY,
          size: 9,
          font: helveticaFont,
          color: PDFLib.rgb(0.3, 0.3, 0.3),
        });
        
        invoiceY -= 12;
        
        if (dueDate) {
          page.drawText(`Due Date: ${formatDate(dueDate)}`, {
            x: 350,
            y: invoiceY,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          invoiceY -= 12;
        }
        
        if (poNumber) {
          page.drawText(`PO Number: ${poNumber}`, {
            x: 350,
            y: invoiceY,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
        }
        
        y = Math.min(billY, invoiceY) - 30;
        
        // Add items table
        statusMessage.textContent = "Adding invoice items...";
        progressBar.style.width = "50%";
        
        const tableHeaders = ["#", "Item Description", "HSN/SAC", "Qty", "Unit Price", "GST %", "Amount"];
        const columnWidths = [25, 180, 60, 40, 70, 50, 80];
        const tableStartY = y;
        
        // Draw table header background
        page.drawRectangle({
          x: 45,
          y: y - 5,
          width: 505,
          height: 25,
          color: PDFLib.rgb(0.95, 0.95, 0.95),
          borderColor: PDFLib.rgb(0.7, 0.7, 0.7),
          borderWidth: 1,
        });
        
        // Draw table headers
        let x = 50;
        tableHeaders.forEach((header, index) => {
          page.drawText(header, {
            x: x,
            y: y,
            size: 9,
            font: helveticaBoldFont,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          x += columnWidths[index];
        });
        
        y -= 25;
        
        // Add table rows
        const rows = document.querySelectorAll('#itemsTableBody tr');
        const totals = calculateInvoiceTotals();
        
        rows.forEach((row, index) => {
          const name = row.querySelector('.item-name').value;
          const hsn = row.querySelector('.item-hsn').value;
          const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
          const price = parseFloat(row.querySelector('.item-price').value) || 0;
          const gst = parseFloat(row.querySelector('.item-gst').value) || 0;
          
          const subtotal = quantity * price;
          const gstAmount = subtotal * (gst / 100);
          const total = subtotal + gstAmount;
          
          // Calculate row height based on item description length
          const itemLines = splitText(name, 25);
          const rowHeight = 20 + (itemLines.length - 1) * 10;
          
          // Draw row background for alternate rows
          if (index % 2 === 0) {
            page.drawRectangle({
              x: 45,
              y: y - rowHeight + 5,
              width: 505,
              height: rowHeight,
              color: PDFLib.rgb(0.98, 0.98, 0.98),
            });
          }
          
          // Draw row data
          x = 50;
          
          page.drawText((index + 1).toString(), {
            x: x,
            y: y,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          x += columnWidths[0];
          
          // Draw item description lines
          itemLines.forEach((line, lineIndex) => {
            page.drawText(line, {
              x: x,
              y: y - (lineIndex * 10),
              size: 9,
              font: helveticaFont,
              color: PDFLib.rgb(0.1, 0.1, 0.1),
            });
          });
          x += columnWidths[1];
          
          page.drawText(hsn, {
            x: x,
            y: y,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          x += columnWidths[2];
          
          page.drawText(quantity.toString(), {
            x: x,
            y: y,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          x += columnWidths[3];
          
          page.drawText(`Rs. ${price.toFixed(2)}`, {
            x: x,
            y: y,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          x += columnWidths[4];
          
          page.drawText(`${gst}%`, {
            x: x,
            y: y,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          x += columnWidths[5];
          
          page.drawText(`Rs. ${total.toFixed(2)}`, {
            x: x,
            y: y,
            size: 9,
            font: helveticaFont,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          
          y -= rowHeight;
        });
        
        // Draw table bottom border
        page.drawLine({
          start: { x: 45, y: y + 5 },
          end: { x: 550, y: y + 5 },
          thickness: 1,
          color: PDFLib.rgb(0.7, 0.7, 0.7),
        });
        
        y -= 30;
        
        // Payment details on left side
        const paymentMode = document.getElementById('paymentMode').value;
        const amountReceived = parseFloat(document.getElementById('amountReceived').value) || 0;
        const balance = parseFloat(totals.totalAmount) - amountReceived;
        
        page.drawText("PAYMENT DETAILS:", {
          x: 50,
          y: y,
          size: 11,
          font: helveticaBoldFont,
          color: PDFLib.rgb(0.2, 0.4, 0.8),
        });
        
        let paymentY = y - 15;
        
        page.drawText(`Payment Mode: ${paymentMode}`, {
          x: 50,
          y: paymentY,
          size: 9,
          font: helveticaFont,
          color: PDFLib.rgb(0.3, 0.3, 0.3),
        });
        
        paymentY -= 12;
        
        if (paymentMode === "Bank Transfer") {
          const bankDetails = [
            "Account Name: Myrtille Industries",
            "Account No.: 921020038756944",
            "Bank: Axis Bank, Swej Farm, Jaipur",
            "IFSC: UTIB0002582"
          ];
          
          bankDetails.forEach(line => {
            page.drawText(line, {
              x: 50,
              y: paymentY,
              size: 9,
              font: helveticaFont,
              color: PDFLib.rgb(0.3, 0.3, 0.3),
            });
            paymentY -= 10;
          });
        }
        
        // Terms and conditions (one line)
        const terms = document.getElementById('terms').value;
        const termsLine = splitText(terms, 70)[0];
        
        page.drawText(`Terms: ${termsLine}`, {
          x: 50,
          y: paymentY - 20,
          size: 8,
          font: helveticaFont,
          color: PDFLib.rgb(0.4, 0.4, 0.4),
        });
        
        // Totals box on right side
        statusMessage.textContent = "Calculating totals...";
        progressBar.style.width = "70%";
        
        const totalsBoxWidth = 250;
        const totalsBoxX = 550 - totalsBoxWidth;
        const totalsBoxHeight = 170;
        
        // Draw totals box
        page.drawRectangle({
          x: totalsBoxX - 10,
          y: y - totalsBoxHeight,
          width: totalsBoxWidth,
          height: totalsBoxHeight,
          color: PDFLib.rgb(0.98, 0.98, 0.98),
          borderColor: PDFLib.rgb(0.7, 0.7, 0.7),
          borderWidth: 1,
        });
        
        let totalsY = y - 10;
        
        const totalsData = [
          ["Sub Total", `Rs. ${totals.subtotal}`],
          ["Discount", `- Rs. ${totals.discount}`],
          ["Shipping", `+ Rs. ${totals.shipping}`],
        ];
        
        // Add GST breakdown
        if (totals.isSameState) {
          totalsData.push(["CGST @9%", `Rs. ${totals.cgst}`]);
          totalsData.push(["SGST @9%", `Rs. ${totals.sgst}`]);
        } else {
          totalsData.push(["IGST @18%", `Rs. ${totals.igst}`]);
        }
        
        totalsData.push(
          ["Total Amount", `Rs. ${totals.totalAmount}`],
          ["Amount Received", `- Rs. ${amountReceived.toFixed(2)}`],
        );
        
        totalsData.forEach(([label, value], index) => {
          const isTotal = label === "Total Amount";
          
          page.drawText(label, {
            x: totalsBoxX,
            y: totalsY,
            size: isTotal ? 10 : 9,
            font: isTotal ? helveticaBoldFont : helveticaFont,
            color: isTotal ? PDFLib.rgb(0.1, 0.1, 0.1) : PDFLib.rgb(0.3, 0.3, 0.3),
          });
          
          page.drawText(value, {
            x: totalsBoxX + 150,
            y: totalsY,
            size: isTotal ? 10 : 9,
            font: isTotal ? helveticaBoldFont : helveticaFont,
            color: isTotal ? PDFLib.rgb(0.1, 0.1, 0.1) : PDFLib.rgb(0.3, 0.3, 0.3),
          });
          
          totalsY -= isTotal ? 15 : 12;
          
          // Add line after total
          if (label === "Total Amount") {
            page.drawLine({
              start: { x: totalsBoxX, y: totalsY + 5 },
              end: { x: totalsBoxX + 180, y: totalsY + 5 },
              thickness: 0.5,
              color: PDFLib.rgb(0.5, 0.5, 0.5),
            });
            totalsY -= 5;
          }
        });
        
        // Balance Due in bold
        page.drawText("Balance Due", {
          x: totalsBoxX,
          y: totalsY,
          size: 10,
          font: helveticaBoldFont,
          color: PDFLib.rgb(0.9, 0.2, 0.2),
        });
        
        page.drawText(`Rs. ${balance.toFixed(2)}`, {
          x: totalsBoxX + 150,
          y: totalsY,
          size: 10,
          font: helveticaBoldFont,
          color: PDFLib.rgb(0.9, 0.2, 0.2),
        });
        
        totalsY -= 25;
        
        // Amount in words (only rupees part)
        const amountWords = numberToWords(totals.totalAmount);
        const wordsLines = splitText(`Amount in Words: ${amountWords}`, 40);
        
        wordsLines.forEach(line => {
          page.drawText(line, {
            x: totalsBoxX,
            y: totalsY,
            size: 8,
            font: helveticaFont,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          totalsY -= 10;
        });
        
        y = paymentY - 40;
        
        // Add signature section
        statusMessage.textContent = "Adding signature...";
        progressBar.style.width = "90%";
        
        // Draw signature line
        page.drawLine({
          start: { x: 400, y: y },
          end: { x: 550, y: y },
          thickness: 1,
          color: PDFLib.rgb(0.1, 0.1, 0.1),
        });
        
        page.drawText("For Myrtille Industries", {
          x: 400,
          y: y - 15,
          size: 10,
          font: helveticaBoldFont,
          color: PDFLib.rgb(0.1, 0.1, 0.1),
        });
        
        page.drawText("Authorized Signatory", {
          x: 400,
          y: y - 30,
          size: 9,
          font: helveticaFont,
          color: PDFLib.rgb(0.3, 0.3, 0.3),
        });
        
        // Add footer
        page.drawText("Thank you for your business!", {
          x: 200,
          y: 30,
          size: 10,
          font: helveticaObliqueFont,
          color: PDFLib.rgb(0.2, 0.4, 0.8),
        });
        
        page.drawText("Software Generated Invoice | Myrtille Industries Invoice System", {
          x: 150,
          y: 15,
          size: 7,
          font: helveticaFont,
          color: PDFLib.rgb(0.5, 0.5, 0.5),
        });
        
        // Save PDF
        statusMessage.textContent = "Finalizing PDF...";
        progressBar.style.width = "100%";
        
        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        
        // Generate filename
        const invoiceNumberClean = invoiceNumber.replace(/[^a-zA-Z0-9]/g, '_');
        const filename = `Myrtille_Invoice_${invoiceNumberClean}.pdf`;
        
        // Save file
        saveAs(blob, filename);
        
        statusMessage.textContent = "Invoice generated successfully!";
        
        setTimeout(() => {
          statusArea.classList.remove('active');
          successMessage.style.display = 'block';
          setTimeout(() => {
            successMessage.style.display = 'none';
          }, 4000);
        }, 1000);
        
      } catch (error) {
        console.error('Error generating PDF:', error);
        document.getElementById('errorText').textContent = `Error generating PDF: ${error.message}`;
        errorMessage.style.display = 'block';
        statusArea.classList.remove('active');
      }
    }
    
    // Helper function to format date
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-IN', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    }
    
    // Helper function to split text into lines
    function splitText(text, maxLength) {
      const words = text.split(' ');
      const lines = [];
      let currentLine = '';
      
      words.forEach(word => {
        if ((currentLine + ' ' + word).length <= maxLength) {
          currentLine += (currentLine ? ' ' : '') + word;
        } else {
          if (currentLine) lines.push(currentLine);
          currentLine = word;
        }
      });
      
      if (currentLine) lines.push(currentLine);
      return lines;
    }
    
    // Function to reset form
    function resetForm() {
      if (confirm("Are you sure you want to reset the form? All data will be lost.")) {
        document.getElementById('invoiceForm').reset();
        
        // Reset dates
        const today = new Date();
        const dueDate = new Date();
        dueDate.setDate(today.getDate() + 30);
        
        document.getElementById('invoiceDate').value = today.toISOString().split('T')[0];
        document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
        
        // Reset items table
        document.getElementById('itemsTableBody').innerHTML = '';
        addItemRow();
        
        // Add sample data
        addSampleData();
      }
    }
    
    // Function to add sample data for demo
    function addSampleData() {
      // Set sample customer data
      document.getElementById('customerName').value = "SUPERINTENDENT CUM MEMBER SECRETARY RMRS";
      document.getElementById('customerAddress').value = "SUPER SPECIALITY HOSPITAL, RNT MEDICAL COLLEGE, UDAIPUR";
      document.getElementById('customerContact').value = "9829851042";
      
      // Clear any existing rows and add sample item
      document.getElementById('itemsTableBody').innerHTML = '';
      addItemRow({
        name: "RAT AND PEST CONTROL SERVICES - ANNUAL CONTRACT",
        hsn: "999311",
        quantity: 1,
        price: 35416,
        gst: 18
      });
      
      // Add another sample item
      addItemRow({
        name: "SANITIZATION AND DISINFECTION SERVICES",
        hsn: "999312",
        quantity: 4,
        price: 2500,
        gst: 18
      });
    }
  </script>
</body>
</html>
