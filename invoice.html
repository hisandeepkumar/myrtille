<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Myrtille Industries - Invoice Generator</title>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: #2c3e50;
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.8;
      font-size: 16px;
    }

    .content {
      padding: 30px;
    }

    .form-section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 20px;
      color: #2c3e50;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #3498db;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      color: #3498db;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      color: #34495e;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .form-group input, 
    .form-group textarea, 
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.3s;
    }

    .form-group input:focus, 
    .form-group textarea:focus, 
    .form-group select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .items-table th {
      background: #3498db;
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 500;
    }

    .items-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }

    .items-table input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: #2ecc71;
      color: white;
    }

    .btn-primary:hover {
      background: #27ae60;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
    }

    .btn-secondary {
      background: #3498db;
      color: white;
    }

    .btn-secondary:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .status-area {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      text-align: center;
    }

    .status-area.active {
      display: block;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      margin-top: 20px;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      margin-top: 20px;
    }

    .back-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: all 0.3s;
      z-index: 1000;
    }

    .back-btn:hover {
      transform: scale(1.1);
    }

    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="back-btn" onclick="history.back()">
    <i class="fas fa-arrow-left"></i>
  </div>

  <div class="container">
    <div class="header">
      <h1><i class="fas fa-file-invoice"></i> Invoice Generator</h1>
      <p>Myrtille Industries - Professional Tax Invoice</p>
    </div>

    <div class="content">
      <form id="invoiceForm">
        <!-- Invoice Details -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-receipt"></i>
            <span>Invoice Details</span>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="invoiceNumber">Invoice Number *</label>
              <input type="text" id="invoiceNumber" value="INV-2024-001" required>
            </div>
            
            <div class="form-group">
              <label for="invoiceDate">Invoice Date *</label>
              <input type="date" id="invoiceDate" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="dueDate">Due Date</label>
              <input type="date" id="dueDate">
            </div>
            
            <div class="form-group">
              <label for="poNumber">PO Number (Optional)</label>
              <input type="text" id="poNumber">
            </div>
          </div>
        </div>

        <!-- Customer Details -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-user-tie"></i>
            <span>Customer Details</span>
          </div>
          
          <div class="form-group">
            <label for="customerName">Customer Name *</label>
            <input type="text" id="customerName" value="SUPERINTENDENT CUM MEMBER SECRETARY RMRS" required>
          </div>
          
          <div class="form-group">
            <label for="customerAddress">Customer Address *</label>
            <textarea id="customerAddress" required>SUPER SPECIALITY HOSPITAL, RNT MEDICAL COLLEGE, UDAIPUR</textarea>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="customerContact">Contact No. *</label>
              <input type="text" id="customerContact" value="9829851042" required>
            </div>
            
            <div class="form-group">
              <label for="customerEmail">Email (Optional)</label>
              <input type="email" id="customerEmail">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="customerGST">Customer GSTIN (Optional)</label>
              <input type="text" id="customerGST">
            </div>
            
            <div class="form-group">
              <label for="customerState">State Code (Optional)</label>
              <input type="text" id="customerState" placeholder="e.g., 08">
            </div>
          </div>
        </div>

        <!-- Invoice Items -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-list"></i>
            <span>Invoice Items</span>
          </div>
          
          <table class="items-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Item Description</th>
                <th>HSN/SAC</th>
                <th>Qty</th>
                <th>Price/Unit (Rs.)</th>
                <th>GST %</th>
                <th>Amount (Rs.)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="itemsTableBody">
              <!-- Items will be added here -->
            </tbody>
          </table>
          
          <button type="button" class="btn btn-secondary" id="addItemBtn" style="margin-top: 15px;">
            <i class="fas fa-plus"></i> Add Item
          </button>
          
          <div class="form-row" style="margin-top: 20px;">
            <div class="form-group">
              <label for="discount">Discount (Rs.)</label>
              <input type="number" id="discount" value="0" min="0" step="0.01">
            </div>
            
            <div class="form-group">
              <label for="shipping">Shipping Charges (Rs.)</label>
              <input type="number" id="shipping" value="0" min="0" step="0.01">
            </div>
          </div>
        </div>

        <!-- Payment Details -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-credit-card"></i>
            <span>Payment Details</span>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="amountReceived">Amount Received (Rs.)</label>
              <input type="number" id="amountReceived" value="0" min="0" step="0.01">
            </div>
            
            <div class="form-group">
              <label for="paymentMode">Payment Mode</label>
              <select id="paymentMode">
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Cash">Cash</option>
                <option value="Cheque">Cheque</option>
                <option value="Online">Online</option>
                <option value="UPI">UPI</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label for="terms">Terms and Conditions (One Line)</label>
            <input type="text" id="terms" value="Payment due within 30 days of invoice date. Late payment interest @18% p.a.">
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="button-group">
          <button type="button" class="btn btn-primary" id="generateInvoiceBtn">
            <i class="fas fa-file-pdf"></i> Generate Invoice PDF
          </button>
          
          <button type="button" class="btn btn-danger" id="resetFormBtn">
            <i class="fas fa-redo"></i> Reset Form
          </button>
        </div>
      </form>

      <div class="status-area" id="statusArea">
        <h3><i class="fas fa-cog fa-spin"></i> Generating your invoice...</h3>
        <p id="statusMessage">Initializing PDF generation...</p>
      </div>

      <div class="success-message" id="successMessage" style="display: none;">
        <i class="fas fa-check-circle"></i> Invoice generated successfully!
      </div>
      
      <div class="error-message" id="errorMessage" style="display: none;">
        <i class="fas fa-exclamation-circle"></i> <span id="errorText">Error generating invoice</span>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script>
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Set dates
      const today = new Date();
      const dueDate = new Date();
      dueDate.setDate(today.getDate() + 30);
      
      document.getElementById('invoiceDate').value = today.toISOString().split('T')[0];
      document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
      
      // Add first item
      addItemRow();
      
      // Event listeners
      document.getElementById('addItemBtn').addEventListener('click', () => addItemRow());
      document.getElementById('generateInvoiceBtn').addEventListener('click', generateInvoicePDF);
      document.getElementById('resetFormBtn').addEventListener('click', resetForm);
      
      // Add sample data
      addSampleData();
    });
    
    // Add item row
    function addItemRow(itemData = {}) {
      const tbody = document.getElementById('itemsTableBody');
      const rowCount = tbody.children.length + 1;
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${rowCount}</td>
        <td><input type="text" class="item-name" value="${itemData.name || ''}" placeholder="Item description"></td>
        <td><input type="text" class="item-hsn" value="${itemData.hsn || ''}" placeholder="HSN/SAC"></td>
        <td><input type="number" class="item-quantity" value="${itemData.quantity || 1}" min="1" step="1"></td>
        <td><input type="number" class="item-price" value="${itemData.price || 0}" min="0" step="0.01"></td>
        <td>
          <select class="item-gst">
            <option value="0" ${itemData.gst === 0 ? 'selected' : ''}>0%</option>
            <option value="5" ${itemData.gst === 5 ? 'selected' : ''}>5%</option>
            <option value="12" ${itemData.gst === 12 ? 'selected' : ''}>12%</option>
            <option value="18" ${itemData.gst === 18 ? 'selected' : ''}>18%</option>
            <option value="28" ${itemData.gst === 28 ? 'selected' : ''}>28%</option>
          </select>
        </td>
        <td class="item-amount">Rs. 0.00</td>
        <td>
          <div class="action-buttons">
            <button type="button" class="action-btn" style="background:#3498db;color:white;" onclick="calculateItemAmount(this)">Calc</button>
            <button type="button" class="action-btn" style="background:#e74c3c;color:white;" onclick="removeItemRow(this)">Delete</button>
          </div>
        </td>
      `;
      
      tbody.appendChild(row);
      
      // Add input listeners
      row.querySelectorAll('.item-quantity, .item-price, .item-gst').forEach(input => {
        input.addEventListener('input', () => calculateItemAmount(row));
      });
      
      calculateItemAmount(row);
    }
    
    // Calculate item amount
    function calculateItemAmount(element) {
      const row = element.closest('tr');
      const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
      const price = parseFloat(row.querySelector('.item-price').value) || 0;
      const gst = parseFloat(row.querySelector('.item-gst').value) || 0;
      
      const subtotal = quantity * price;
      const gstAmount = subtotal * (gst / 100);
      const total = subtotal + gstAmount;
      
      row.querySelector('.item-amount').textContent = `Rs. ${total.toFixed(2)}`;
      updateRowNumbers();
    }
    
    // Remove item row
    function removeItemRow(button) {
      const row = button.closest('tr');
      row.remove();
      updateRowNumbers();
    }
    
    // Update row numbers
    function updateRowNumbers() {
      document.querySelectorAll('#itemsTableBody tr').forEach((row, index) => {
        row.querySelector('td:first-child').textContent = index + 1;
      });
    }
    
    // Calculate totals
    function calculateTotals() {
      const rows = document.querySelectorAll('#itemsTableBody tr');
      let subtotal = 0;
      let totalGST = 0;
      let cgst = 0;
      let sgst = 0;
      let igst = 0;
      
      const isSameState = document.getElementById('customerState').value === '08' || 
                         !document.getElementById('customerState').value;
      
      rows.forEach(row => {
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        const gst = parseFloat(row.querySelector('.item-gst').value) || 0;
        
        const itemSubtotal = quantity * price;
        const itemGST = itemSubtotal * (gst / 100);
        
        subtotal += itemSubtotal;
        totalGST += itemGST;
        
        if (isSameState) {
          cgst += itemGST / 2;
          sgst += itemGST / 2;
        } else {
          igst += itemGST;
        }
      });
      
      const discount = parseFloat(document.getElementById('discount').value) || 0;
      const shipping = parseFloat(document.getElementById('shipping').value) || 0;
      const totalAmount = subtotal + totalGST - discount + shipping;
      const amountReceived = parseFloat(document.getElementById('amountReceived').value) || 0;
      const balanceDue = totalAmount - amountReceived;
      
      return {
        subtotal: subtotal.toFixed(2),
        totalGST: totalGST.toFixed(2),
        cgst: cgst.toFixed(2),
        sgst: sgst.toFixed(2),
        igst: igst.toFixed(2),
        discount: discount.toFixed(2),
        shipping: shipping.toFixed(2),
        totalAmount: totalAmount.toFixed(2),
        amountReceived: amountReceived.toFixed(2),
        balanceDue: balanceDue.toFixed(2),
        isSameState
      };
    }
    
    // Number to words (only rupees part)
    function numberToWords(num) {
      const units = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
      const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
      const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
      
      const rupees = Math.floor(num);
      if (rupees === 0) return 'Zero Rupees only';
      
      let words = '';
      
      // Crore
      const crore = Math.floor(rupees / 10000000);
      if (crore > 0) {
        words += convertLessThanThousand(crore) + ' Crore ';
      }
      
      // Lakh
      const lakh = Math.floor((rupees % 10000000) / 100000);
      if (lakh > 0) {
        words += convertLessThanThousand(lakh) + ' Lakh ';
      }
      
      // Thousand
      const thousand = Math.floor((rupees % 100000) / 1000);
      if (thousand > 0) {
        words += convertLessThanThousand(thousand) + ' Thousand ';
      }
      
      // Hundred
      const hundred = Math.floor((rupees % 1000) / 100);
      if (hundred > 0) {
        words += units[hundred] + ' Hundred ';
      }
      
      // Tens and units
      const lastTwo = rupees % 100;
      if (lastTwo > 0) {
        if (words !== '') words += 'and ';
        words += convertLessThanThousand(lastTwo);
      }
      
      return words.trim() + ' Rupees only';
      
      function convertLessThanThousand(n) {
        if (n < 10) return units[n];
        if (n < 20) return teens[n - 10];
        const ten = Math.floor(n / 10);
        const unit = n % 10;
        return tens[ten] + (unit > 0 ? ' ' + units[unit] : '');
      }
    }
    
    // Generate PDF
    async function generateInvoicePDF() {
      // Show status
      const statusArea = document.getElementById('statusArea');
      const statusMessage = document.getElementById('statusMessage');
      const successMessage = document.getElementById('successMessage');
      const errorMessage = document.getElementById('errorMessage');
      
      successMessage.style.display = 'none';
      errorMessage.style.display = 'none';
      statusArea.classList.add('active');
      statusMessage.textContent = "Creating PDF document...";
      
      try {
        // Create PDF
        const pdfDoc = await PDFLib.PDFDocument.create();
        const page = pdfDoc.addPage([595.28, 841.89]); // A4
        
        // Fonts
        const helvetica = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
        const helveticaBold = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
        
        // Try to load header image
        let headerImage = null;
        try {
          statusMessage.textContent = "Loading header image...";
          const headerResponse = await fetch('myrtille_header.png');
          if (headerResponse.ok) {
            const headerBytes = await headerResponse.arrayBuffer();
            const image = await pdfDoc.embedPng(headerBytes);
            const dims = image.scaleToFit(595.28 - 100, 200);
            page.drawImage(image, {
              x: 50,
              y: 800 - dims.height,
              width: dims.width,
              height: dims.height,
            });
          }
        } catch (e) {
          console.log('Header image not found, using text header');
          // Draw text header
          page.drawText("MYRTILLE INDUSTRIES", {
            x: 200,
            y: 800,
            size: 24,
            font: helveticaBold,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          page.drawText("PLOT-25, DEEPNAGAR, NEAR GUJAR KI THADI, JAIPUR, 302019", {
            x: 120,
            y: 770,
            size: 10,
            font: helvetica,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          page.drawText("Phone: 9782099489 | Email: myrtilleindia@gmail.com", {
            x: 180,
            y: 755,
            size: 9,
            font: helvetica,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          page.drawText("GSTIN: 08AMHPY5013C1Z4 | PAN: AMHPY5013C", {
            x: 180,
            y: 740,
            size: 9,
            font: helvetica,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
        }
        
        let y = headerImage ? 720 : 720;
        
        // Invoice title
        page.drawText("TAX INVOICE", {
          x: 250,
          y: y,
          size: 20,
          font: helveticaBold,
          color: PDFLib.rgb(0.2, 0.4, 0.8),
        });
        
        y -= 40;
        
        // Bill To (Left) and Invoice Details (Right)
        const customerName = document.getElementById('customerName').value;
        const customerAddress = document.getElementById('customerAddress').value;
        const customerContact = document.getElementById('customerContact').value;
        
        // Bill To section
        page.drawText("BILL TO:", {
          x: 50,
          y: y,
          size: 12,
          font: helveticaBold,
          color: PDFLib.rgb(0.2, 0.4, 0.8),
        });
        
        let billY = y - 15;
        page.drawText(customerName, {
          x: 50,
          y: billY,
          size: 10,
          font: helveticaBold,
          color: PDFLib.rgb(0.1, 0.1, 0.1),
        });
        
        billY -= 12;
        const addressLines = splitText(customerAddress, 40);
        addressLines.forEach(line => {
          page.drawText(line, {
            x: 50,
            y: billY,
            size: 9,
            font: helvetica,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          billY -= 10;
        });
        
        page.drawText(`Contact: ${customerContact}`, {
          x: 50,
          y: billY - 10,
          size: 9,
          font: helvetica,
          color: PDFLib.rgb(0.3, 0.3, 0.3),
        });
        
        // Invoice Details
        const invoiceNumber = document.getElementById('invoiceNumber').value;
        const invoiceDate = document.getElementById('invoiceDate').value;
        const dueDate = document.getElementById('dueDate').value;
        const poNumber = document.getElementById('poNumber').value;
        
        page.drawText("INVOICE DETAILS:", {
          x: 350,
          y: y,
          size: 12,
          font: helveticaBold,
          color: PDFLib.rgb(0.2, 0.4, 0.8),
        });
        
        let invY = y - 15;
        page.drawText(`Invoice No: ${invoiceNumber}`, {
          x: 350,
          y: invY,
          size: 9,
          font: helvetica,
          color: PDFLib.rgb(0.3, 0.3, 0.3),
        });
        
        invY -= 12;
        page.drawText(`Invoice Date: ${formatDate(invoiceDate)}`, {
          x: 350,
          y: invY,
          size: 9,
          font: helvetica,
          color: PDFLib.rgb(0.3, 0.3, 0.3),
        });
        
        invY -= 12;
        if (dueDate) {
          page.drawText(`Due Date: ${formatDate(dueDate)}`, {
            x: 350,
            y: invY,
            size: 9,
            font: helvetica,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          invY -= 12;
        }
        
        if (poNumber) {
          page.drawText(`PO Number: ${poNumber}`, {
            x: 350,
            y: invY,
            size: 9,
            font: helvetica,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
        }
        
        y = Math.min(billY, invY) - 40;
        
        // Items table
        statusMessage.textContent = "Adding items table...";
        const columnWidths = [30, 200, 60, 40, 70, 50, 80];
        
        // Table header
        page.drawRectangle({
          x: 45,
          y: y - 5,
          width: 505,
          height: 25,
          color: PDFLib.rgb(0.95, 0.95, 0.95),
          borderColor: PDFLib.rgb(0.7, 0.7, 0.7),
          borderWidth: 1,
        });
        
        let x = 50;
        ['#', 'Item Description', 'HSN/SAC', 'Qty', 'Unit Price', 'GST %', 'Amount'].forEach((header, i) => {
          page.drawText(header, {
            x: x,
            y: y,
            size: 9,
            font: helveticaBold,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          x += columnWidths[i];
        });
        
        y -= 25;
        
        // Table rows
        const rows = document.querySelectorAll('#itemsTableBody tr');
        const totals = calculateTotals();
        
        rows.forEach((row, index) => {
          const name = row.querySelector('.item-name').value;
          const hsn = row.querySelector('.item-hsn').value;
          const quantity = row.querySelector('.item-quantity').value;
          const price = parseFloat(row.querySelector('.item-price').value) || 0;
          const gst = row.querySelector('.item-gst').value;
          
          // Alternate row background
          if (index % 2 === 0) {
            page.drawRectangle({
              x: 45,
              y: y - 15,
              width: 505,
              height: 20,
              color: PDFLib.rgb(0.98, 0.98, 0.98),
            });
          }
          
          x = 50;
          page.drawText((index + 1).toString(), {
            x: x,
            y: y,
            size: 9,
            font: helvetica,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          x += columnWidths[0];
          
          // Item name
          const nameLines = splitText(name, 25);
          nameLines.forEach((line, idx) => {
            page.drawText(line, {
              x: x,
              y: y - (idx * 10),
              size: 9,
              font: helvetica,
              color: PDFLib.rgb(0.1, 0.1, 0.1),
            });
          });
          x += columnWidths[1];
          
          page.drawText(hsn, { x: x, y: y, size: 9, font: helvetica, color: PDFLib.rgb(0.1, 0.1, 0.1) });
          x += columnWidths[2];
          
          page.drawText(quantity, { x: x, y: y, size: 9, font: helvetica, color: PDFLib.rgb(0.1, 0.1, 0.1) });
          x += columnWidths[3];
          
          page.drawText(`Rs. ${price.toFixed(2)}`, { x: x, y: y, size: 9, font: helvetica, color: PDFLib.rgb(0.1, 0.1, 0.1) });
          x += columnWidths[4];
          
          page.drawText(`${gst}%`, { x: x, y: y, size: 9, font: helvetica, color: PDFLib.rgb(0.1, 0.1, 0.1) });
          x += columnWidths[5];
          
          const amount = (parseFloat(quantity) * price) * (1 + parseFloat(gst)/100);
          page.drawText(`Rs. ${amount.toFixed(2)}`, { x: x, y: y, size: 9, font: helvetica, color: PDFLib.rgb(0.1, 0.1, 0.1) });
          
          y -= 25;
        });
        
        y -= 20;
        
        // Payment details on left
        const paymentMode = document.getElementById('paymentMode').value;
        page.drawText("PAYMENT DETAILS:", {
          x: 50,
          y: y,
          size: 11,
          font: helveticaBold,
          color: PDFLib.rgb(0.2, 0.4, 0.8),
        });
        
        let payY = y - 15;
        page.drawText(`Payment Mode: ${paymentMode}`, {
          x: 50,
          y: payY,
          size: 9,
          font: helvetica,
          color: PDFLib.rgb(0.3, 0.3, 0.3),
        });
        
        if (paymentMode === "Bank Transfer") {
          payY -= 12;
          page.drawText("Account Name: Myrtille Industries", {
            x: 50,
            y: payY,
            size: 9,
            font: helvetica,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          payY -= 10;
          page.drawText("Account No.: 921020038756944", {
            x: 50,
            y: payY,
            size: 9,
            font: helvetica,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          payY -= 10;
          page.drawText("Bank: Axis Bank, Swej Farm, Jaipur", {
            x: 50,
            y: payY,
            size: 9,
            font: helvetica,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          payY -= 10;
          page.drawText("IFSC: UTIB0002582", {
            x: 50,
            y: payY,
            size: 9,
            font: helvetica,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
        }
        
        // Terms
        const terms = document.getElementById('terms').value;
        page.drawText(`Terms: ${terms}`, {
          x: 50,
          y: payY - 20,
          size: 8,
          font: helvetica,
          color: PDFLib.rgb(0.4, 0.4, 0.4),
        });
        
        // Totals box on right
        const totalsBoxX = 350;
        let totalsY = y - 10;
        
        page.drawRectangle({
          x: totalsBoxX - 10,
          y: totalsY - 150,
          width: 250,
          height: 160,
          color: PDFLib.rgb(0.98, 0.98, 0.98),
          borderColor: PDFLib.rgb(0.7, 0.7, 0.7),
          borderWidth: 1,
        });
        
        const totalsData = [
          ["Sub Total", `Rs. ${totals.subtotal}`],
          ["Discount", `- Rs. ${totals.discount}`],
          ["Shipping", `+ Rs. ${totals.shipping}`],
        ];
        
        if (totals.isSameState) {
          totalsData.push(["CGST @9%", `Rs. ${totals.cgst}`]);
          totalsData.push(["SGST @9%", `Rs. ${totals.sgst}`]);
        } else {
          totalsData.push(["IGST @18%", `Rs. ${totals.igst}`]);
        }
        
        totalsData.push(
          ["Total Amount", `Rs. ${totals.totalAmount}`],
          ["Amount Received", `- Rs. ${totals.amountReceived}`],
          ["Balance Due", `Rs. ${totals.balanceDue}`]
        );
        
        totalsData.forEach(([label, value], i) => {
          const isBold = label === "Total Amount" || label === "Balance Due";
          
          page.drawText(label, {
            x: totalsBoxX,
            y: totalsY,
            size: isBold ? 10 : 9,
            font: isBold ? helveticaBold : helvetica,
            color: label === "Balance Due" ? PDFLib.rgb(0.9, 0.2, 0.2) : 
                  (isBold ? PDFLib.rgb(0.1, 0.1, 0.1) : PDFLib.rgb(0.3, 0.3, 0.3)),
          });
          
          page.drawText(value, {
            x: totalsBoxX + 150,
            y: totalsY,
            size: isBold ? 10 : 9,
            font: isBold ? helveticaBold : helvetica,
            color: label === "Balance Due" ? PDFLib.rgb(0.9, 0.2, 0.2) : 
                  (isBold ? PDFLib.rgb(0.1, 0.1, 0.1) : PDFLib.rgb(0.3, 0.3, 0.3)),
          });
          
          totalsY -= i === totalsData.length - 4 ? 17 : 14;
          
          if (label === "Total Amount") {
            page.drawLine({
              start: { x: totalsBoxX, y: totalsY + 7 },
              end: { x: totalsBoxX + 180, y: totalsY + 7 },
              thickness: 0.5,
              color: PDFLib.rgb(0.5, 0.5, 0.5),
            });
            totalsY -= 5;
          }
        });
        
        // Amount in words
        totalsY -= 10;
        const amountWords = numberToWords(parseFloat(totals.totalAmount));
        const wordsLines = splitText(`Amount in Words: ${amountWords}`, 40);
        wordsLines.forEach(line => {
          page.drawText(line, {
            x: totalsBoxX,
            y: totalsY,
            size: 8,
            font: helvetica,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
          totalsY -= 10;
        });
        
        // Signature
        statusMessage.textContent = "Adding signature...";
        let signY = payY - 50;
        
        try {
          const signResponse = await fetch('myrtille_signature.png');
          if (signResponse.ok) {
            const signBytes = await signResponse.arrayBuffer();
            const signImage = await pdfDoc.embedPng(signBytes);
            const signDims = signImage.scaleToFit(100, 60);
            
            page.drawImage(signImage, {
              x: 400,
              y: signY - signDims.height,
              width: signDims.width,
              height: signDims.height,
            });
            
            page.drawText("For Myrtille Industries", {
              x: 400,
              y: signY - signDims.height - 15,
              size: 10,
              font: helveticaBold,
              color: PDFLib.rgb(0.1, 0.1, 0.1),
            });
            
            page.drawText("Authorized Signatory", {
              x: 400,
              y: signY - signDims.height - 30,
              size: 9,
              font: helvetica,
              color: PDFLib.rgb(0.3, 0.3, 0.3),
            });
          }
        } catch (e) {
          // Draw signature line if image not found
          page.drawLine({
            start: { x: 400, y: signY },
            end: { x: 550, y: signY },
            thickness: 1,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          
          page.drawText("For Myrtille Industries", {
            x: 400,
            y: signY - 15,
            size: 10,
            font: helveticaBold,
            color: PDFLib.rgb(0.1, 0.1, 0.1),
          });
          
          page.drawText("Authorized Signatory", {
            x: 400,
            y: signY - 30,
            size: 9,
            font: helvetica,
            color: PDFLib.rgb(0.3, 0.3, 0.3),
          });
        }
        
        // Footer
        page.drawText("Thank you for your business!", {
          x: 200,
          y: 30,
          size: 10,
          font: helvetica,
          color: PDFLib.rgb(0.2, 0.4, 0.8),
        });
        
        page.drawText("Software Generated Invoice - Myrtille Industries", {
          x: 170,
          y: 15,
          size: 8,
          font: helvetica,
          color: PDFLib.rgb(0.5, 0.5, 0.5),
        });
        
        // Save PDF
        statusMessage.textContent = "Finalizing PDF...";
        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        
        const filename = `Myrtille_Invoice_${invoiceNumber.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
        saveAs(blob, filename);
        
        // Show success
        statusArea.classList.remove('active');
        successMessage.style.display = 'block';
        
        setTimeout(() => {
          successMessage.style.display = 'none';
        }, 4000);
        
      } catch (error) {
        console.error('Error:', error);
        statusArea.classList.remove('active');
        errorMessage.style.display = 'block';
        document.getElementById('errorText').textContent = error.message;
      }
    }
    
    // Helper functions
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-IN', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    }
    
    function splitText(text, maxLen) {
      const words = text.split(' ');
      const lines = [];
      let line = '';
      
      words.forEach(word => {
        if ((line + ' ' + word).length <= maxLen) {
          line += (line ? ' ' : '') + word;
        } else {
          if (line) lines.push(line);
          line = word;
        }
      });
      
      if (line) lines.push(line);
      return lines;
    }
    
    function resetForm() {
      if (confirm("Reset all form data?")) {
        document.getElementById('invoiceForm').reset();
        
        // Reset dates
        const today = new Date();
        const dueDate = new Date();
        dueDate.setDate(today.getDate() + 30);
        
        document.getElementById('invoiceDate').value = today.toISOString().split('T')[0];
        document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
        
        // Reset items
        document.getElementById('itemsTableBody').innerHTML = '';
        addItemRow();
        
        addSampleData();
      }
    }
    
    function addSampleData() {
      document.getElementById('customerName').value = "SUPERINTENDENT CUM MEMBER SECRETARY RMRS";
      document.getElementById('customerAddress').value = "SUPER SPECIALITY HOSPITAL, RNT MEDICAL COLLEGE, UDAIPUR";
      document.getElementById('customerContact').value = "9829851042";
      
      document.getElementById('itemsTableBody').innerHTML = '';
      addItemRow({
        name: "RAT AND PEST CONTROL SERVICES - ANNUAL CONTRACT",
        hsn: "999311",
        quantity: 1,
        price: 35416,
        gst: 18
      });
      
      addItemRow({
        name: "SANITIZATION AND DISINFECTION SERVICES",
        hsn: "999312",
        quantity: 4,
        price: 2500,
        gst: 18
      });
    }
  </script>
</body>
</html>
