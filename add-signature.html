<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDF Signature Adder — Fixed Preview</title>

  <!-- libs -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    *{ box-sizing:border-box; font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial; }
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('https://images.unsplash.com/photo-1557683316-973673baf926?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2029&q=80');
      background-size:cover; background-position:center; padding:24px; color:#f0f0f0;
    }

    .container{
      width:100%; max-width:960px; background:rgba(255,255,255,0.12);
      backdrop-filter: blur(12px); border-radius:18px; padding:28px; border:1px solid rgba(255,255,255,0.08);
      box-shadow: 0 8px 32px rgba(0,0,0,0.45);
    }

    .header{ text-align:center; padding:12px 6px; border-bottom:1px solid rgba(255,255,255,0.06); margin-bottom:18px; }
    .header h1{ display:flex; gap:10px; align-items:center; justify-content:center; font-size:22px; margin:0; }
    .header h1 i{ color:#5b86e5; font-size:26px; }

    .upload-area {
      border: 2px dashed rgba(255,255,255,0.25);
      border-radius:12px; padding:36px 20px; text-align:center; cursor:pointer; margin-bottom:18px;
      background: rgba(255,255,255,0.02);
      position:relative;
      transition: all 0.3s ease;
    }
    .upload-area:hover{ border-color:#5b86e5; background:rgba(91,134,229,0.04); }
    .upload-area.active { border-color:#5b86e5; background:rgba(91,134,229,0.08); }
    .upload-area i{ font-size:38px; color:#5b86e5; margin-bottom:12px; display:block; }
    .upload-area h3{ margin:6px 0; font-size:18px; color:#fff; }
    .upload-area p{ margin:6px 0; color:rgba(255,255,255,0.8); }

    /* Keep input covering entire area so single click always triggers */
    .upload-area input[type="file"]{ position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer; }

    .controls-row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .controls-row .left{ flex:1; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .controls-row .right{ display:flex; gap:12px; align-items:center; }

    .file-list{ max-height:500px; overflow:auto; margin:12px 0; padding-right:8px; }
    .preview-list{ display:flex; flex-direction:column; gap:14px; }

    .preview-item{ background: rgba(255,255,255,0.02); border-radius:10px; padding:12px; display:flex; flex-direction:column; align-items:center; }
    .preview-item h3{ margin:0 0 8px; color:#dbeafe; font-weight:600; }

    .canvas-wrap{ position:relative; display:inline-block; }
    canvas{ display:block; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.45); background:white; }

    .sig-layer{ position:absolute; left:0; top:0; pointer-events:auto; }
    .signature{ position:absolute; cursor:move; touch-action:none; user-select:none; display:flex; align-items:center; }
    .signature img{ display:block; width:189px; height:auto; pointer-events:none; opacity:0.96; }
    .delete-btn{ position:absolute; right:-10px; top:-10px; width:26px; height:26px; background:#ef4444; color:white; border-radius:50%; border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; }

    .file-item{ display:flex; align-items:center; justify-content:space-between; padding:10px; border-radius:8px; margin-bottom:8px; background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,0) 100%); background-size:200% 100%; -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-weight:700; text-decoration:underline; }
    .file-item small{ color:rgba(255,255,255,0.6); font-weight:500; text-decoration:none; -webkit-text-fill-color:initial; background:none; }

    .add-file-btn{ width:44px; height:44px; border-radius:50%; background:#5b86e5; display:flex; align-items:center; justify-content:center; cursor:pointer; color:white; margin-left:6px; }
    .btn{ display:block; margin:18px auto 0; padding:12px 26px; border-radius:30px; background:rgba(255,255,255,0.08); color:#fff; border:1px solid rgba(255,255,255,0.06); cursor:pointer; font-weight:700; transition: all 0.3s ease; }
    .btn:hover:not(:disabled) { background:rgba(255,255,255,0.15); transform: translateY(-2px); }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; }

    .progress-container{ width:100%; height:8px; background:rgba(255,255,255,0.04); border-radius:6px; overflow:hidden; margin-top:12px; display:none; }
    .progress-bar{ height:100%; width:0%; background:#5b86e5; transition:width 260ms linear; }

    .footer{ margin-top:18px; text-align:center; color:rgba(255,255,255,0.7); font-size:13px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.04); }

    @media (max-width:760px){
      .container{ padding:16px; }
      .signature img{ width:140px; }
      .controls-row{ flex-direction: column; align-items: flex-start; }
      .controls-row .right{ margin-top: 10px; }
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-file-signature"></i> PDF Signature Adder</h1>
    </div>

    <div class="upload-area" id="uploadArea">
      <i class="fas fa-cloud-upload-alt"></i>
      <h3>Upload a PDF file (single)</h3>
      <p>Click here or drag & drop — file will upload once and show previews for every page</p>
      <!-- file input covers area so one click works reliably -->
      <input id="pdfFileInput" type="file" accept="application/pdf">
    </div>

    <div class="controls-row">
      <div class="left">
        <label style="font-weight:700; color:#eaf4ff">Signature Image (optional)</label>
        <input id="sigImageInput" type="file" accept="image/*" style="border-radius:8px; padding:6px;">
        <small id="sigInfo" style="margin-left:8px; color:#dbeafe; display:inline-block"></small>
      </div>

      <div class="right">
        <label style="font-weight:700; color:#eaf4ff; margin-right:6px">Signature width</label>
        <input id="sigWidth" type="range" min="50" max="350" value="189" style="vertical-align:middle;">
        <span id="sigWidthVal" style="margin-left:8px; font-weight:700">189 px</span>
      </div>
    </div>

    <div class="file-list" id="fileList">
      <!-- page previews will appear here as list -->
      <div id="previewList" class="preview-list"></div>
    </div>

    <div class="progress-container" id="progressContainer"><div class="progress-bar" id="progressBar"></div></div>

    <button class="btn" id="generateBtn" disabled>Generate Signed PDF</button>

    <div class="footer">Secure • Professional — Keep your <strong>default_signature.png</strong> in same folder for default</div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', ()=> {
  const pdfInput = document.getElementById('pdfFileInput');
  const uploadArea = document.getElementById('uploadArea');
  const previewList = document.getElementById('previewList');
  const sigImageInput = document.getElementById('sigImageInput');
  const sigInfo = document.getElementById('sigInfo');
  const sigWidth = document.getElementById('sigWidth');
  const sigWidthVal = document.getElementById('sigWidthVal');
  const generateBtn = document.getElementById('generateBtn');
  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');

  // Set up PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

  const DPR = window.devicePixelRatio || 1;
  let selectedPdfFile = null;
  let pdfLibDoc = null;
  let pdfJsDoc = null;
  let selectedImageFile = null;
  let signatureImgUrl = null;
  let signatureWidthPx = 189; // default as requested
  let pageData = []; // per page meta and signatures

  // fallback inline svg
  const FALLBACK_SIG = `data:image/svg+xml;base64,${btoa(
    `<svg xmlns='http://www.w3.org/2000/svg' width='400' height='150'>
      <path d='M10 90 C 60 10, 140 10, 190 90 S 330 170, 390 90' stroke='#111827' stroke-width='6' fill='none' stroke-linecap='round' />
    </svg>`
  )}`;

  function fmt(bytes){
    if(!bytes) return '';
    if(bytes<1024) return bytes+' B';
    if(bytes<1024*1024) return (bytes/1024).toFixed(2)+' KB';
    return (bytes/(1024*1024)).toFixed(2)+' MB';
  }

  // try to load default_signature.png, if present — store but don't block UI
  async function loadDefaultSignatureIfExists(){
    if(selectedImageFile) return;
    try {
      const resp = await fetch('default_signature.png', {cache:'no-store'});
      if(!resp.ok) throw new Error('not found');
      const blob = await resp.blob();
      selectedImageFile = new File([blob], 'default_signature.png', { type: blob.type });
      signatureImgUrl = URL.createObjectURL(blob);
      sigInfo.textContent = `Default loaded: default_signature.png (${fmt(blob.size)})`;
    } catch (err){
      // fallback to inline
      signatureImgUrl = FALLBACK_SIG;
      sigInfo.textContent = `Using fallback signature`;
      console.warn('default_signature.png not found — using fallback SVG.');
    }
  }

  // update slider text and visible signatures widths
  sigWidth.addEventListener('input', ()=> {
    signatureWidthPx = parseInt(sigWidth.value,10);
    sigWidthVal.textContent = signatureWidthPx + ' px';
    document.querySelectorAll('.signature img').forEach(img => img.style.width = signatureWidthPx + 'px');
    pageData.forEach(p => p.signatures && p.signatures.forEach(s => s.visualWidth = signatureWidthPx));
  });

  // handle signature image upload by user
  sigImageInput.addEventListener('change', (e)=> {
    if(!e.target.files?.length) return;
    const f = e.target.files[0];
    if(!f.type.startsWith('image/')) { alert('Select an image file (PNG/JPEG/SVG)'); return; }
    selectedImageFile = f;
    signatureImgUrl = URL.createObjectURL(f);
    sigInfo.textContent = `Signature: ${f.name} (${fmt(f.size)})`;
  });

  // upload area drag/drop visuals
  ['dragenter','dragover'].forEach(ev => {
    uploadArea.addEventListener(ev, (e)=> { 
      e.preventDefault(); 
      uploadArea.classList.add('active'); 
    });
  });
  ['dragleave','drop'].forEach(ev => {
    uploadArea.addEventListener(ev, (e)=> { 
      e.preventDefault(); 
      uploadArea.classList.remove('active'); 
    });
  });
  uploadArea.addEventListener('drop', (e)=>{
    if(e.dataTransfer?.files?.length) handlePdfFile(e.dataTransfer.files[0]);
  });

  // single file input change — only once needed
  pdfInput.addEventListener('change', (e)=> {
    if(e.target.files?.length) handlePdfFile(e.target.files[0]);
  });

  // handle selected PDF (single file)
  async function handlePdfFile(file){
    if(!file) return;
    if(file.type !== 'application/pdf'){ alert('Please select a PDF file'); return; }

    // clean previous state
    previewList.innerHTML = '';
    pageData = [];
    generateBtn.disabled = true;
    selectedPdfFile = file;

    // Show loading state
    uploadArea.innerHTML = '<i class="fas fa-spinner fa-spin"></i><h3>Loading PDF...</h3>';
    
    try {
      const arrayBuffer = await file.arrayBuffer();
      pdfLibDoc = await PDFLib.PDFDocument.load(arrayBuffer);
      pdfJsDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      
      // render previews (list)
      const total = pdfLibDoc.getPageCount();
      const MAX_DISPLAY_WIDTH = 800;
      
      for(let p=1; p<=total; p++){
        const page = await pdfJsDoc.getPage(p);
        const viewport = page.getViewport({ scale: 1.0 });
        
        // Calculate appropriate scale for display
        const scale = Math.min(1.0, MAX_DISPLAY_WIDTH / viewport.width);
        const scaledViewport = page.getViewport({ scale });
        
        const cssW = Math.round(scaledViewport.width);
        const cssH = Math.round(scaledViewport.height);
        
        const canvas = document.createElement('canvas');
        canvas.width = Math.floor(cssW * DPR);
        canvas.height = Math.floor(cssH * DPR);
        canvas.style.width = cssW + 'px';
        canvas.style.height = cssH + 'px';
        
        const ctx = canvas.getContext('2d');
        ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
        
        await page.render({
          canvasContext: ctx,
          viewport: scaledViewport
        }).promise;

        const libPage = pdfLibDoc.getPage(p-1);
        const psize = libPage.getSize();

        // create preview item
        const item = document.createElement('div');
        item.className = 'preview-item';
        const title = document.createElement('h3');
        title.textContent = `Page ${p}`;
        item.appendChild(title);

        const wrap = document.createElement('div');
        wrap.className = 'canvas-wrap';
        wrap.style.width = cssW + 'px';
        wrap.style.height = cssH + 'px';
        wrap.appendChild(canvas);

        const layer = document.createElement('div');
        layer.className = 'sig-layer';
        layer.style.width = cssW + 'px';
        layer.style.height = cssH + 'px';
        layer.style.left = '0';
        layer.style.top = '0';
        layer.style.pointerEvents = 'auto';
        wrap.appendChild(layer);

        item.appendChild(wrap);
        previewList.appendChild(item);

        pageData[p-1] = {
          pdfSize: { width: psize.width, height: psize.height },
          viewport: { width: scaledViewport.width, height: scaledViewport.height },
          canvasSize: { cssWidth: cssW, cssHeight: cssH },
          layerElement: layer,
          wrapElement: wrap,
          signatures: []
        };

        // click to place signature
        layer.addEventListener('click', async (ev)=>{
          ev.preventDefault();
          await loadDefaultSignatureIfExists();
          if(!signatureImgUrl){ alert('Signature missing'); return; }
          const rect = layer.getBoundingClientRect();
          const clientX = ev.clientX;
          const clientY = ev.clientY;
          const x_css = clientX - rect.left;
          const y_css = clientY - rect.top;
          addSignatureToPage(p-1, x_css, y_css);
        });
      }

      // Reset upload area
      uploadArea.innerHTML = `
        <i class="fas fa-cloud-upload-alt"></i>
        <h3>Upload a PDF file (single)</h3>
        <p>Click here or drag & drop — file will upload once and show previews for every page</p>
        <input id="pdfFileInput" type="file" accept="application/pdf">
      `;
      
      // Re-attach event listener to the new input
      document.getElementById('pdfFileInput').addEventListener('change', (e) => {
        if(e.target.files?.length) handlePdfFile(e.target.files[0]);
      });

    } catch (err){
      console.error('PDF load/render error', err);
      alert('Error loading PDF: '+ (err.message || err));
      
      // Reset upload area on error
      uploadArea.innerHTML = `
        <i class="fas fa-cloud-upload-alt"></i>
        <h3>Upload a PDF file (single)</h3>
        <p>Click here or drag & drop — file will upload once and show previews for every page</p>
        <input id="pdfFileInput" type="file" accept="application/pdf">
      `;
      
      // Re-attach event listener to the new input
      document.getElementById('pdfFileInput').addEventListener('change', (e) => {
        if(e.target.files?.length) handlePdfFile(e.target.files[0]);
      });
    }
  }

  // add signature to specific page (DOM + stored PDF coords)
  function addSignatureToPage(pageIndex, x_css, y_css){
    const pd = pageData[pageIndex];
    if(!pd) return;
    const layer = pd.layerElement;
    const id = `sig-${pageIndex}-${Date.now()}`;
    const sig = document.createElement('div');
    sig.className = 'signature';
    sig.id = id;
    const left = x_css - (signatureWidthPx/2);
    const top = y_css - (signatureWidthPx/2);
    sig.style.left = Math.max(0,left) + 'px';
    sig.style.top = Math.max(0,top) + 'px';
    sig.style.width = signatureWidthPx + 'px';

    const img = document.createElement('img');
    img.src = signatureImgUrl || FALLBACK_SIG;
    img.style.width = signatureWidthPx + 'px';
    sig.appendChild(img);

    const del = document.createElement('button');
    del.className = 'delete-btn';
    del.innerHTML = '<i class="fas fa-trash"></i>';
    del.addEventListener('click', (e)=> {
      e.stopPropagation();
      sig.remove();
      pd.signatures = pd.signatures.filter(s => s.id !== id);
      generateBtn.disabled = pageData.every(p=> !p.signatures || p.signatures.length===0);
    });
    sig.appendChild(del);

    layer.appendChild(sig);

    // map css coords => PDF pts
    const scaleX = pd.pdfSize.width / pd.viewport.width;
    const scaleY = pd.pdfSize.height / pd.viewport.height;
    const pdfX = (left) * scaleX;
    const pdfTop = (top) * scaleY;

    const stored = { id, x_pdf: pdfX, top_pdf: pdfTop, visualWidth: signatureWidthPx };
    pd.signatures.push(stored);

    makeDraggable(sig, pageIndex, stored);
    generateBtn.disabled = false;
  }

  function makeDraggable(domEl, pageIndex, stored){
    let dragging=false, startX=0, startY=0, startLeft=0, startTop=0;
    const layer = pageData[pageIndex].layerElement;

    const onDown = (e) => {
      e.preventDefault();
      dragging = true;
      const cx = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
      const cy = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
      startX = cx; startY = cy;
      startLeft = parseFloat(domEl.style.left || 0);
      startTop = parseFloat(domEl.style.top || 0);
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
      document.addEventListener('touchmove', onMove, {passive:false});
      document.addEventListener('touchend', onUp);
    };

    const onMove = (e) => {
      if(!dragging) return;
      e.preventDefault();
      const cx = e.type.startsWith('touch') ? e.touches[0].clientX : e.clientX;
      const cy = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
      const dx = cx - startX, dy = cy - startY;
      let newLeft = startLeft + dx, newTop = startTop + dy;
      newLeft = Math.max(0, Math.min(newLeft, layer.clientWidth - domEl.offsetWidth));
      newTop = Math.max(0, Math.min(newTop, layer.clientHeight - domEl.offsetHeight));
      domEl.style.left = newLeft + 'px';
      domEl.style.top = newTop + 'px';

      const pd = pageData[pageIndex];
      const scaleX = pd.pdfSize.width / pd.viewport.width;
      const scaleY = pd.pdfSize.height / pd.viewport.height;
      stored.x_pdf = newLeft * scaleX;
      stored.top_pdf = newTop * scaleY;
      stored.visualWidth = parseFloat(domEl.offsetWidth);
    };

    const onUp = (e) => {
      dragging=false;
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('touchend', onUp);
    };

    domEl.addEventListener('mousedown', onDown);
    domEl.addEventListener('touchstart', onDown, {passive:false});
  }

  // update progress UI
  function updateProgress(pct){
    progressContainer.style.display = 'block';
    progressBar.style.width = `${pct}%`;
  }

  // generate final PDF
  generateBtn.addEventListener('click', async ()=> {
    if(!selectedPdfFile) { alert('Upload a PDF first'); return; }
    if(pageData.every(pd => !pd.signatures || pd.signatures.length===0)) { alert('Place at least one signature'); return; }
    await loadDefaultSignatureIfExists();
    try {
      generateBtn.disabled = true;
      updateProgress(5);
      const arr = await selectedPdfFile.arrayBuffer();
      updateProgress(20);
      const pdfDoc = await PDFLib.PDFDocument.load(arr);
      updateProgress(40);

      // embed image (handle svg -> png rasterize)
      let embedded;
      if(selectedImageFile && (selectedImageFile.type === 'image/svg+xml' || selectedImageFile.name.endsWith('.svg'))){
        // rasterize SVG
        const imgBytes = await selectedImageFile.arrayBuffer();
        const svgText = await (new Response(imgBytes)).text();
        const imgEl = new Image();
        const blob = new Blob([svgText], {type:'image/svg+xml'});
        const url = URL.createObjectURL(blob);
        await new Promise((res, rej)=> { imgEl.onload = res; imgEl.onerror = rej; imgEl.src = url; });
        const c = document.createElement('canvas');
        c.width = imgEl.naturalWidth || 400;
        c.height = imgEl.naturalHeight || 150;
        c.getContext('2d').drawImage(imgEl,0,0,c.width,c.height);
        const png = c.toDataURL('image/png');
        const raw = atob(png.split(',')[1]);
        const u8 = new Uint8Array(raw.length);
        for(let i=0;i<raw.length;i++) u8[i]=raw.charCodeAt(i);
        embedded = await pdfDoc.embedPng(u8);
        URL.revokeObjectURL(url);
      } else if(selectedImageFile && selectedImageFile.type === 'image/png') {
        const imgBytes = await selectedImageFile.arrayBuffer();
        embedded = await pdfDoc.embedPng(imgBytes);
      } else if(selectedImageFile) {
        const imgBytes = await selectedImageFile.arrayBuffer();
        embedded = await pdfDoc.embedJpg(imgBytes);
      } else {
        // Use fallback signature
        const response = await fetch(FALLBACK_SIG);
        const svgText = await response.text();
        const imgEl = new Image();
        const blob = new Blob([svgText], {type:'image/svg+xml'});
        const url = URL.createObjectURL(blob);
        await new Promise((res, rej)=> { imgEl.onload = res; imgEl.onerror = rej; imgEl.src = url; });
        const c = document.createElement('canvas');
        c.width = imgEl.naturalWidth || 400;
        c.height = imgEl.naturalHeight || 150;
        c.getContext('2d').drawImage(imgEl,0,0,c.width,c.height);
        const png = c.toDataURL('image/png');
        const raw = atob(png.split(',')[1]);
        const u8 = new Uint8Array(raw.length);
        for(let i=0;i<raw.length;i++) u8[i]=raw.charCodeAt(i);
        embedded = await pdfDoc.embedPng(u8);
        URL.revokeObjectURL(url);
      }
      updateProgress(60);

      const pages = pdfDoc.getPages();
      for(let i=0;i<pages.length;i++){
        const page = pages[i];
        const pd = pageData[i];
        if(!pd || !pd.signatures || pd.signatures.length === 0) continue;
        for(const s of pd.signatures){
          const pdfW = (s.visualWidth || signatureWidthPx) * (pd.pdfSize.width / pd.viewport.width);
          const imgW = embedded.width, imgH = embedded.height;
          const pdfH = (pdfW / imgW) * imgH;
          const yBottom = pd.pdfSize.height - s.top_pdf - pdfH;
          page.drawImage(embedded, { x: s.x_pdf, y: yBottom, width: pdfW, height: pdfH, opacity:1 });
        }
      }

      updateProgress(85);
      const out = await pdfDoc.save();
      updateProgress(95);

      const blob = new Blob([out], { type:'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `SIGNED_${Date.now()}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      updateProgress(100);
      setTimeout(()=>{ progressContainer.style.display='none'; progressBar.style.width='0%'; }, 600);

      // reset small state (keep default signature loaded)
      previewList.innerHTML = '';
      pageData = [];
      selectedPdfFile = null;
      generateBtn.disabled = true;
    } catch (err){
      console.error('Generate error', err);
      alert('Error generating document: '+ (err.message || err));
      generateBtn.disabled = false;
      progressContainer.style.display = 'none';
      progressBar.style.width = '0%';
    }
  });

  // Initial load of default signature
  loadDefaultSignatureIfExists();
});
</script>
</body>
</html>
